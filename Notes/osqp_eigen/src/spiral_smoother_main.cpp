/**
 * @file spiral_smoother_main.cpp
 * @brief 对比各个平滑器的耗时以及拟合效果
 * @author Wang Dezhao (1282507109@qq.com)
 * @version 1.0
 * @date 2022-06-07 15:30:50
 *
 * @copyright Copyright (c) 2022
 */

#include <chrono>
#include <fstream>
#include <iomanip>
#include <iostream>
#include <sstream>

//#include "../math/math_method/curve_math.h"
#include "curve.h"
#include "curve_creator.h"
#include "curve_segment.h"
#include "matplotlibcpp.h"
#include "osqp_spline_2d_solver.h"
#include "spiral_reference_line_smoother.h"

// reference
#include "curve.h"
#include "curve_creator.h"
#include "curve_segment.h"
using namespace reference_line;

using apollo::common::math::Vec2d;
using Eigen::MatrixXd;
using namespace apollo;
using namespace planning;
namespace plt = matplotlibcpp;

template <typename T>
using vector_Eigen = std::vector<T, Eigen::aligned_allocator<T>>;

template <typename T>
T calc_point_theta(T y_x_t, T x) {
  return std::atan2(y_x_t, x);
};

void cal_path_kappa(std::vector<double> &raw_xs, std::vector<double> &raw_ys,
                    std::vector<double> &final_kappas,
                    std::vector<double> &final_dkappas) {
  reference_line::CurveCreator creator(raw_xs, raw_ys);

  creator.solve();

  auto &curve = creator.curve();
  double length = curve->length();

  // constexpr int N = 200;
  int N = raw_xs.size() - 1;
  double stride = length / N;

  // std::vector<double> final_xs, final_ys, final_kappas, final_dkappas,
  std::vector<double> final_deltas;
  final_deltas = curve->deltas_;

  for (double i = 0; i < N + 1; i++) {
    // final_xs.emplace_back(curve->x(i * stride));
    // final_ys.emplace_back(curve->y(i * stride));
    final_kappas.emplace_back(curve->kappa(i * stride));
    final_dkappas.emplace_back(curve->dkappa(i * stride));
  }
}

namespace apollo::planning {
/**
 * @brief 等距弧长离散园
 * 由于圆的特殊性，其圆弧上每一点的曲率均相等，故可以将等弧长与相同的角度相对应
 * @param  x
 * @param  y
 * @param  r
 * @param  size
 */
void div_circle(std::vector<double> &x, std::vector<double> &y, double r,
                double size)  // xy对应圆心坐标,r为半径,size用于设置划分的间距
{
  double angle_step = 0;  //一小步的弧度
  angle_step = size / r;
  double x_out, y_out;

  for (int i = M_PI / angle_step; i > 0; --i) {
    x_out = r * cos(i * angle_step);
    y_out = r * sin(i * angle_step);
    x.push_back(x_out);
    y.push_back(y_out);
  }
}
}  // namespace apollo::planning

void read_csv(std::vector<Eigen::Vector2d> &raw_points_) {
  std::ifstream inFile(
      "/home/next/routing_planning/Notes/osqp_eigen/path_points.csv",
      std::ios::in);
  std::string lineStr;
  char delim = ',';
  if (!inFile) {
    std::cout << "打开文件失败！" << std::endl;
  }
  std::vector<double> raw_xs, raw_ys;
  getline(inFile, lineStr);
  while (getline(inFile, lineStr)) {
    std::stringstream ss(lineStr);
    std::string str;
    std::vector<double> points;
    while (getline(ss, str, delim)) {
      points.emplace_back(std::stod(str));
    }
    raw_xs.emplace_back(points.at(0));
    raw_ys.emplace_back(points.at(1));
  }

  raw_points_.resize(raw_xs.size());

  for (size_t i = 0; i < raw_xs.size(); ++i) {
    raw_points_[i] = {raw_xs[i], raw_ys[i]};
  }
}

void write_to_csv(std::vector<double> &r_x_, std::vector<double> &r_y_) {
  std::ofstream outFile;
  outFile.open("solve_path_points.csv", std::ios::out);
  outFile << "x_value" << ',' << "y_value" << '\n';
  for (size_t i = 0; i < r_x_.size(); ++i) {
    outFile << r_x_.at(i) << ',' << r_y_.at(i) << '\n';
  }
  outFile.close();
}

void SetPoints(std::vector<Eigen::Vector2d> &raw_points_) {
#if 0
  raw_points_.resize(4);
  raw_points_[0] = {0.0, 0.0};
  raw_points_[1] = {1.0, 0.3};
  raw_points_[2] = {2.0, 0.0};
  raw_points_[3] = {3, 0.1};
#endif

#if 0
  std::vector<double> raw_xs, raw_ys;
  div_circle(raw_xs, raw_ys, 5, 1);

  raw_points_.resize(raw_xs.size());

  for (size_t i = 0; i < raw_xs.size(); ++i) {
    raw_points_[i] = {raw_xs[i], raw_ys[i]};
  }
#endif

#if 0
  raw_points_.resize(21);

  raw_points_[0] = {4.946317773, 0.08436953512};
  raw_points_[1] = {5.017218975, 0.7205757236};
  raw_points_[2] = {4.734635316, 1.642930209};
  raw_points_[3] = {4.425064575, 2.365356462};
  raw_points_[4] = {3.960102096, 2.991632152};
  raw_points_[5] = {3.503172702, 3.44091492};
  raw_points_[6] = {2.989950824, 3.9590821};
  raw_points_[7] = {2.258523535, 4.554377368};
  raw_points_[8] = {1.562447892, 4.656801472};
  raw_points_[9] = {0.8764776599, 4.971705856};
  raw_points_[10] = {0.09899323097, 4.985845841};
  raw_points_[11] = {-0.7132021974, 5.010851105};
  raw_points_[12] = {-1.479055426, 4.680181989};
  raw_points_[13] = {-2.170306775, 4.463442715};
  raw_points_[14] = {-3.034455492, 4.074651273};
  raw_points_[15] = {-3.621987909, 3.585790302};
  raw_points_[16] = {-3.979289889, 3.014232351};
  raw_points_[17] = {-4.434628966, 2.367848826};
  raw_points_[18] = {-4.818245921, 1.467395733};
  raw_points_[19] = {-4.860190444, 0.8444358019};
  raw_points_[20] = {-5.09947597, -0.01022405467};
#endif

#if 1
std::vector<std::pair<double, double>> path{{0,0},
                                            {0.2,-0.0164316},
                                            {0.4,-0.0328633},
                                            {0.6,-0.0492949},
                                            {0.8,-0.0657266},
                                            {1,-0.0821582},
                                            {1.2,-0.0985898},
                                            {1.4,-0.115021},
                                            {1.6,-0.131453},
                                            {1.8,-0.147885},
                                            {2,-0.164316},
                                            {2.2,-0.180748},
                                            {2.4,-0.19718},
                                            {2.6,-0.213611},
                                            {2.8,-0.230043},
                                            {3,-0.246475},
                                            {3.2,-0.262906},
                                            {3.4,-0.279338},
                                            {3.6,-0.29577},
                                            {3.8,-0.312201},
                                            {4,-0.328633},
                                            {4.2,-0.345064},
                                            {4.4,-0.361496},
                                            {4.6,-0.377928},
                                            {4.8,-0.394359},
                                            {5,-0.410791},
                                            {5.2,-0.427223},
                                            {5.4,-0.443654},
                                            {5.6,-0.460086},
                                            {5.8,-0.476518},
                                            {6,-0.492949},
                                            {6.2,-0.509381},
                                            {6.4,-0.525813},
                                            {6.6,-0.542244},
                                            {6.8,-0.558676},
                                            {7,-0.575107},
                                            {7.2,-0.591539},
                                            {7.4,-0.607971},
                                            {7.6,-0.624402},
                                            {7.8,-0.640834},
                                            {8,-0.657266},
                                            {8.2,-0.673697},
                                            {8.4,-0.690129},
                                            {8.6,-0.706561},
                                            {8.8,-0.722992},
                                            {9,-0.739424},
                                            {9.2,-0.755855},
                                            {9.4,-0.772287},
                                            {9.6,-0.788719},
                                            {9.8,-0.80515},
                                            {10,-0.821582},
                                            {10.2,-0.838014},
                                            {10.4,-0.854445},
                                            {10.6,-0.870877},
                                            {10.8,-0.887309},
                                            {11,-0.90374},
                                            {11.2,-0.920172},
                                            {11.4,-0.936604},
                                            {11.6,-0.953035},
                                            {11.8,-0.969467},
                                            {12,-0.985898},
                                            {12.2,-1.00233},
                                            {12.4,-1.01876},
                                            {12.6,-1.03519},
                                            {12.8,-1.05163},
                                            {13,-1.07345},
                                            {13.2,-1.09527},
                                            {13.4,-1.1171},
                                            {13.6,-1.13892},
                                            {13.8,-1.16075},
                                            {14,-1.18257},
                                            {14.2,-1.20439},
                                            {14.4,-1.22622},
                                            {14.6,-1.24804},
                                            {14.8,-1.26987},
                                            {15,-1.29169},
                                            {15.2,-1.31352},
                                            {15.4,-1.33534},
                                            {15.6,-1.35716},
                                            {15.8,-1.37899},
                                            {16,-1.40081},
                                            {16.2,-1.42264},
                                            {16.4,-1.44446},
                                            {16.6,-1.46629},
                                            {16.8,-1.48811},
                                            {17,-1.50993},
                                            {17.2,-1.53176},
                                            {17.4,-1.55358},
                                            {17.6,-1.57541},
                                            {17.8,-1.59723},
                                            {18,-1.61905},
                                            {18.2,-1.64088},
                                            {18.4,-1.6627},
                                            {18.6,-1.68453},
                                            {18.8,-1.70635},
                                            {19,-1.72818},
                                            {19.2,-1.75},
                                            {19.4,-1.77182},
                                            {19.6,-1.79365},
                                            {19.8,-1.81547},
                                            {20,-1.8373},
                                            {20.2,-1.85912},
                                            {20.4,-1.88095},
                                            {20.6,-1.90277},
                                            {20.8,-1.92459},
                                            {21,-1.94642},
                                            {21.2,-1.96824},
                                            {21.4,-1.99007},
                                            {21.6,-2.01189},
                                            {21.8,-2.03371},
                                            {22,-2.05554},
                                            {22.2,-2.07736},
                                            {22.4,-2.09919},
                                            {22.6,-2.12101},
                                            {22.8,-2.14284},
                                            {23,-2.16466},
                                            {23.2,-2.18648},
                                            {23.4,-2.20831},
                                            {23.6,-2.23013},
                                            {23.8,-2.25196},
                                            {24,-2.27378},
                                            {24.2,-2.29561},
                                            {24.4,-2.31743},
                                            {24.6,-2.33925},
                                            {24.8,-2.36108},
                                            {25,-2.3829},
                                            {25.2,-2.40473},
                                            {25.4,-2.42655},
                                            {25.6,-2.44837},
                                            {25.9,-2.4702},
                                            {26.2,-2.49202},
                                            {26.5,-2.51385},
                                            {26.8,-2.53567},
                                            {27.1,-2.5575},
                                            {27.4,-2.57932},
                                            {27.7,-2.60114},
                                            {28,-2.62297},
                                            {28.3,-2.64479},
                                            {28.6,-2.66662},
                                            {28.9,-2.68844},
                                            {29.2,-2.71027},
                                            {29.5,-2.73209},
                                            {29.8,-2.75391},
                                            {30.1,-2.77574},
                                            {30.4,-2.79756},
                                            {30.7,-2.81939},
                                            {31,-2.84121},
                                            {31.3,-2.86304},
                                            {31.6,-2.88486},
                                            {31.9,-2.90668},
                                            {32.2,-2.92851},
                                            {32.5,-2.95033},
                                            {32.8,-2.97216},
                                            {33.1,-2.99398},
                                            {33.4,-3.0158},
                                            {33.7,-3.03763},
                                            {34,-3.05945},
                                            {34.3,-3.08128},
                                            {34.6,-3.1031},
                                            {34.9,-3.12493},
                                            {35.2,-3.14675},
                                            {35.5,-3.16857},
                                            {35.8,-3.1904},
                                            {36.1,-3.21222},
                                            {36.4,-3.23405},
                                            {36.7,-3.25587},
                                            {37,-3.2777},
                                            {37.3,-3.29952},
                                            {37.6,-3.32134},
                                            {37.9,-3.34317},
                                            {38.2,-3.36499},
                                            {38.5,-3.38682},
                                            {38.8,-3.40864},
                                            {39.1,-3.43046},
                                            {39.4,-3.45229},
                                            {39.7,-3.47411},
                                            {40,-3.49594},
                                            {40.3,-3.51776},
                                            {40.6,-3.53959},
                                            {40.9,-3.56141},
                                            {41.2,-3.58323},
                                            {41.5,-3.60506},
                                            {41.8,-3.62688},
                                            {42.1,-3.64871},
                                            {42.4,-3.67053},
                                            {42.7,-3.69236},
                                            {43,-3.71418},
                                            {43.3,-3.736},
                                            {43.6,-3.75783},
                                            {43.9,-3.77965},
                                            {44.2,-3.80148},
                                            {44.5,-3.8233},
                                            {44.8,-3.84512},
                                            {45.1,-3.83421},
                                            {45.4,-3.8233},
                                            {45.7,-3.81239},
                                            {46,-3.80148},
                                            {46.3,-3.79056},
                                            {46.6,-3.77965},
                                            {46.9,-3.76874},
                                            {47.2,-3.75783},
                                            {47.5,-3.74692},
                                            {47.8,-3.736},
                                            {48.1,-3.72509},
                                            {48.4,-3.71418},
                                            {48.7,-3.70327},
                                            {49,-3.69236},
                                            {49.3,-3.68144},
                                            {49.6,-3.67053},
                                            {49.9,-3.65962},
                                            {50.213,-3.6462},
                                            {50.6819,-3.61457},
                                            {51.1485,-3.56129},
                                            {51.6115,-3.48653},
                                            {52.0701,-3.39049},
                                            {52.5233,-3.27343},
                                            {52.9701,-3.13564},
                                            {53.4096,-2.97746},
                                            {53.8407,-2.79927},
                                            {54.2627,-2.60151},
                                            {54.6747,-2.38463},
                                            {55.0757,-2.14915},
                                            {55.4649,-1.89561},
                                            {55.8416,-1.6246},
                                            {56.2049,-1.33673},
                                            {56.5541,-1.03266},
                                            {56.8885,-0.713078},
                                            {57.2073,-0.378706},
                                            {57.51,-0.0302944},
                                            {57.7959,0.331378},
                                            {58.0645,0.705506},
                                            {58.3151,1.09126},
                                            {58.5473,1.48778},
                                            {58.7607,1.89419},
                                            {58.9547,2.3096},
                                            {59.1292,2.7331},
                                            {59.2836,3.16375},
                                            {59.4178,3.60062},
                                            {59.5314,4.04275},
                                            {59.6244,4.48919},
                                            {59.6964,4.93895},
                                            {59.7475,5.39107},
                                            {59.7775,5.84458},
                                            {59.7865,6.29848},
                                            {59.7744,6.75181},
                                            {59.7413,7.2036},
                                            {59.6875,7.65286},
                                            {59.6129,8.09865},
                                            {59.5178,8.54002},
                                            {59.4025,8.97601},
                                            {59.2673,9.40572},
                                            {59.1125,9.82822},
                                            {58.9384,10.2426},
                                            {58.7456,10.6481},
                                            {58.5344,11.0437},
                                            {58.3053,11.4287},
                                            {58.0589,11.8022},
                                            {57.7958,12.1635},
                                            {57.5165,12.5118},
                                            {57.2217,12.8464},
                                            {56.912,13.1666},
                                            {56.5882,13.4718},
                                            {56.251,13.7613},
                                            {55.9011,14.0345},
                                            {55.5393,14.291},
                                            {55.1664,14.5301},
                                            {54.7833,14.7514},
                                            {54.3908,14.9545},
                                            {53.9898,15.139},
                                            {53.5811,15.3045},
                                            {53.1656,15.4507},
                                            {52.7443,15.5773},
                                            {52.318,15.6841},
                                            {51.8878,15.771},
                                            {51.4545,15.8377},
                                            {51.019,15.8843},
                                            {50.5824,15.9105},
                                            {50.1455,15.9165},
                                            {49.8,15.9067},
                                            {49.5,15.8958},
                                            {49.2,15.8849},
                                            {48.9,15.8739},
                                            {48.6,15.863},
                                            {48.3,15.8521},
                                            {48,15.8412},
                                            {47.7,15.8303},
                                            {47.4,15.8194},
                                            {47.1,15.8085},
                                            {46.8,15.7976},
                                            {46.5,15.7867},
                                            {46.2,15.7757},
                                            {45.9,15.7648},
                                            {45.6,15.7539},
                                            {45.3,15.743},
                                            {45,15.7321},
                                            {44.7,15.7212},
                                            {44.4,15.7103},
                                            {44.1,15.6994},
                                            {43.8,15.6884},
                                            {43.5,15.6775},
                                            {43.2,15.6666},
                                            {42.9,15.6557},
                                            {42.6,15.6448},
                                            {42.3,15.6339},
                                            {42,15.623},
                                            {41.7,15.6121},
                                            {41.4,15.6011},
                                            {41.1,15.5902},
                                            {40.8,15.5793},
                                            {40.5,15.5684},
                                            {40.2,15.5575},
                                            {39.9,15.5466},
                                            {39.6,15.5357},
                                            {39.3,15.5248},
                                            {39,15.5138},
                                            {38.7,15.5029},
                                            {38.4,15.492},
                                            {38.1,15.4811},
                                            {37.8,15.4702},
                                            {37.5,15.4593}};
std::vector<std::pair<double, double>> optim_path{{0,0},
                                                  {0.249679,-3.8377e-05},
                                                  {0.499339,-0.000132929},
                                                  {0.748683,-0.000284127},
                                                  {0.997444,-0.00080546},
                                                  {1.24537,-0.00196535},
                                                  {1.49224,-0.00398794},
                                                  {1.73785,-0.00705472},
                                                  {1.982,-0.0113068},
                                                  {2.22454,-0.0168476},
                                                  {2.46531,-0.0237463},
                                                  {2.70418,-0.0320411},
                                                  {2.94102,-0.0417428},
                                                  {3.17576,-0.0528383},
                                                  {3.4083,-0.0652944},
                                                  {3.63857,-0.079061},
                                                  {3.86653,-0.0940745},
                                                  {4.09215,-0.110261},
                                                  {4.31539,-0.127537},
                                                  {4.53624,-0.145817},
                                                  {4.75472,-0.165008},
                                                  {4.97083,-0.18502},
                                                  {5.18459,-0.20576},
                                                  {5.39604,-0.227137},
                                                  {5.60522,-0.249065},
                                                  {5.81217,-0.271459},
                                                  {6.01696,-0.294239},
                                                  {6.21963,-0.31733},
                                                  {6.42026,-0.340663},
                                                  {6.61892,-0.364172},
                                                  {6.81567,-0.387798},
                                                  {7.0106,-0.411487},
                                                  {7.20378,-0.43519},
                                                  {7.3953,-0.458864},
                                                  {7.58523,-0.482471},
                                                  {7.77367,-0.505975},
                                                  {7.96069,-0.529348},
                                                  {8.14638,-0.552565},
                                                  {8.33082,-0.575604},
                                                  {8.5141,-0.598449},
                                                  {8.69631,-0.621084},
                                                  {8.87751,-0.643499},
                                                  {9.05781,-0.665686},
                                                  {9.23727,-0.687639},
                                                  {9.41598,-0.709355},
                                                  {9.59401,-0.730834},
                                                  {9.77145,-0.752076},
                                                  {9.94835,-0.773085},
                                                  {10.1248,-0.793865},
                                                  {10.3009,-0.814422},
                                                  {10.4766,-0.834763},
                                                  {10.6521,-0.854897},
                                                  {10.8274,-0.874833},
                                                  {11.0026,-0.89458},
                                                  {11.1777,-0.914151},
                                                  {11.3529,-0.933557},
                                                  {11.528,-0.952811},
                                                  {11.7033,-0.971924},
                                                  {11.8787,-0.99091},
                                                  {12.0543,-1.00978},
                                                  {12.2301,-1.02856},
                                                  {12.4062,-1.04724},
                                                  {12.5827,-1.06586},
                                                  {12.7595,-1.08442},
                                                  {12.9367,-1.10293},
                                                  {13.1144,-1.12141},
                                                  {13.2926,-1.13987},
                                                  {13.4712,-1.15833},
                                                  {13.6504,-1.1768},
                                                  {13.8302,-1.19529},
                                                  {14.0106,-1.21381},
                                                  {14.1916,-1.23237},
                                                  {14.3732,-1.25099},
                                                  {14.5555,-1.26967},
                                                  {14.7386,-1.28843},
                                                  {14.9223,-1.30728},
                                                  {15.1069,-1.32622},
                                                  {15.2922,-1.34526},
                                                  {15.4782,-1.36442},
                                                  {15.6651,-1.38369},
                                                  {15.8529,-1.40309},
                                                  {16.0415,-1.42263},
                                                  {16.2309,-1.4423},
                                                  {16.4213,-1.46212},
                                                  {16.6125,-1.48209},
                                                  {16.8048,-1.50222},
                                                  {16.9979,-1.5225},
                                                  {17.192,-1.54294},
                                                  {17.3872,-1.56355},
                                                  {17.5833,-1.58433},
                                                  {17.7805,-1.60527},
                                                  {17.9787,-1.62638},
                                                  {18.178,-1.64766},
                                                  {18.3783,-1.66911},
                                                  {18.5798,-1.69072},
                                                  {18.7824,-1.7125},
                                                  {18.9862,-1.73443},
                                                  {19.1912,-1.75653},
                                                  {19.3973,-1.77878},
                                                  {19.6046,-1.80118},
                                                  {19.8132,-1.82372},
                                                  {20.0231,-1.84639},
                                                  {20.2342,-1.8692},
                                                  {20.4466,-1.89212},
                                                  {20.6603,-1.91516},
                                                  {20.8754,-1.9383},
                                                  {21.0918,-1.96154},
                                                  {21.3096,-1.98486},
                                                  {21.5288,-2.00824},
                                                  {21.7494,-2.03169},
                                                  {21.9715,-2.05518},
                                                  {22.195,-2.07871},
                                                  {22.4199,-2.10225},
                                                  {22.6464,-2.1258},
                                                  {22.8743,-2.14934},
                                                  {23.1037,-2.17285},
                                                  {23.3347,-2.19632},
                                                  {23.5672,-2.21974},
                                                  {23.8012,-2.24308},
                                                  {24.0367,-2.26633},
                                                  {24.2738,-2.28948},
                                                  {24.5124,-2.31251},
                                                  {24.7526,-2.33541},
                                                  {24.9943,-2.35816},
                                                  {25.2376,-2.38074},
                                                  {25.4824,-2.40316},
                                                  {25.7287,-2.42539},
                                                  {25.9766,-2.44742},
                                                  {26.2259,-2.46925},
                                                  {26.4768,-2.49087},
                                                  {26.7291,-2.51228},
                                                  {26.9829,-2.53346},
                                                  {27.2381,-2.55442},
                                                  {27.4948,-2.57517},
                                                  {27.7528,-2.5957},
                                                  {28.0122,-2.61601},
                                                  {28.2729,-2.63613},
                                                  {28.535,-2.65604},
                                                  {28.7983,-2.67578},
                                                  {29.0628,-2.69534},
                                                  {29.3286,-2.71474},
                                                  {29.5956,-2.734},
                                                  {29.8637,-2.75313},
                                                  {30.1329,-2.77216},
                                                  {30.4033,-2.79111},
                                                  {30.6746,-2.81},
                                                  {30.947,-2.82885},
                                                  {31.2204,-2.84768},
                                                  {31.4948,-2.86654},
                                                  {31.77,-2.88543},
                                                  {32.0462,-2.90439},
                                                  {32.3233,-2.92345},
                                                  {32.6012,-2.94265},
                                                  {32.8799,-2.962},
                                                  {33.1594,-2.98155},
                                                  {33.4398,-3.00132},
                                                  {33.7209,-3.02135},
                                                  {34.0027,-3.04167},
                                                  {34.2853,-3.06231},
                                                  {34.5686,-3.0833},
                                                  {34.8526,-3.10467},
                                                  {35.1374,-3.12645},
                                                  {35.4228,-3.14867},
                                                  {35.709,-3.17135},
                                                  {35.9959,-3.19451},
                                                  {36.2836,-3.21818},
                                                  {36.572,-3.24236},
                                                  {36.8612,-3.26708},
                                                  {37.1511,-3.29234},
                                                  {37.4419,-3.31813},
                                                  {37.7335,-3.34447},
                                                  {38.0259,-3.37134},
                                                  {38.3193,-3.39871},
                                                  {38.6136,-3.42657},
                                                  {38.9089,-3.45489},
                                                  {39.2053,-3.48361},
                                                  {39.5028,-3.5127},
                                                  {39.8014,-3.54207},
                                                  {40.1012,-3.57166},
                                                  {40.4023,-3.60138},
                                                  {40.7048,-3.63112},
                                                  {41.0087,-3.66077},
                                                  {41.3141,-3.6902},
                                                  {41.6211,-3.71926},
                                                  {41.9297,-3.74779},
                                                  {42.2401,-3.7756},
                                                  {42.5524,-3.8025},
                                                  {42.8666,-3.82826},
                                                  {43.1829,-3.85266},
                                                  {43.5012,-3.87544},
                                                  {43.8218,-3.89632},
                                                  {44.1446,-3.91501},
                                                  {44.4698,-3.9312},
                                                  {44.7974,-3.94456},
                                                  {45.1275,-3.95474},
                                                  {45.4601,-3.96139},
                                                  {45.7953,-3.96411},
                                                  {46.1331,-3.96253},
                                                  {46.4734,-3.95623},
                                                  {46.8164,-3.94479},
                                                  {47.1619,-3.92778},
                                                  {47.5099,-3.90477},
                                                  {47.8603,-3.8753},
                                                  {48.2131,-3.83892},
                                                  {48.568,-3.79521},
                                                  {48.9249,-3.74371},
                                                  {49.2836,-3.684},
                                                  {49.644,-3.61568},
                                                  {50.0057,-3.53836},
                                                  {50.3686,-3.45169},
                                                  {50.7322,-3.35534},
                                                  {51.0963,-3.24904},
                                                  {51.4607,-3.13255},
                                                  {51.8249,-3.00569},
                                                  {52.1885,-2.8683},
                                                  {52.5515,-2.72025},
                                                  {52.9132,-2.56147},
                                                  {53.2732,-2.39178},
                                                  {53.631,-2.21091},
                                                  {53.986,-2.01859},
                                                  {54.3377,-1.81449},
                                                  {54.6853,-1.59829},
                                                  {55.0279,-1.36967},
                                                  {55.3649,-1.12833},
                                                  {55.6954,-0.874012},
                                                  {56.0183,-0.606519},
                                                  {56.3327,-0.325709},
                                                  {56.6377,-0.0315205},
                                                  {56.9322,0.27602},
                                                  {57.215,0.596793},
                                                  {57.4853,0.930577},
                                                  {57.742,1.27705},
                                                  {57.984,1.63578},
                                                  {58.2103,2.00623},
                                                  {58.4202,2.38778},
                                                  {58.6126,2.77969},
                                                  {58.7868,3.18115},
                                                  {58.9421,3.59127},
                                                  {59.0778,4.00907},
                                                  {59.1933,4.43354},
                                                  {59.2882,4.86357},
                                                  {59.3621,5.29806},
                                                  {59.4146,5.73585},
                                                  {59.4457,6.17575},
                                                  {59.4551,6.61658},
                                                  {59.4429,7.05712},
                                                  {59.4091,7.4962},
                                                  {59.3538,7.93261},
                                                  {59.2773,8.36518},
                                                  {59.1799,8.79276},
                                                  {59.062,9.21423},
                                                  {58.9239,9.62849},
                                                  {58.7663,10.0345},
                                                  {58.5896,10.4312},
                                                  {58.3946,10.8177},
                                                  {58.1819,11.1931},
                                                  {57.9523,11.5564},
                                                  {57.7066,11.907},
                                                  {57.4457,12.2441},
                                                  {57.1704,12.5671},
                                                  {56.8817,12.8753},
                                                  {56.5806,13.1684},
                                                  {56.268,13.446},
                                                  {55.9451,13.7078},
                                                  {55.6127,13.9535},
                                                  {55.272,14.1831},
                                                  {54.9239,14.3966},
                                                  {54.5695,14.5941},
                                                  {54.2097,14.7759},
                                                  {53.8455,14.9421},
                                                  {53.4778,15.0932},
                                                  {53.1073,15.2296},
                                                  {52.735,15.3519},
                                                  {52.3615,15.4607},
                                                  {51.9875,15.5566},
                                                  {51.6137,15.6402},
                                                  {51.2404,15.7124},
                                                  {50.8683,15.7738},
                                                  {50.4977,15.8253},
                                                  {50.1289,15.8676},
                                                  {49.7622,15.9014},
                                                  {49.3979,15.9274},
                                                  {49.0361,15.9465},
                                                  {48.677,15.9593},
                                                  {48.3207,15.9664},
                                                  {47.9671,15.9685},
                                                  {47.6164,15.9662},
                                                  {47.2686,15.9601},
                                                  {46.9236,15.9505},
                                                  {46.5814,15.9381},
                                                  {46.2419,15.9232},
                                                  {45.9052,15.9063},
                                                  {45.5711,15.8877},
                                                  {45.2395,15.8677},
                                                  {44.9104,15.8467},
                                                  {44.5837,15.8249},
                                                  {44.2593,15.8025},
                                                  {43.9372,15.7797},
                                                  {43.6171,15.7567},
                                                  {43.2991,15.7337},
                                                  {42.9831,15.7108},
                                                  {42.6689,15.6881},
                                                  {42.3564,15.6657},
                                                  {42.0457,15.6437},
                                                  {41.7365,15.6222},
                                                  {41.4288,15.6011},
                                                  {41.1224,15.5805},
                                                  {40.8174,15.5606},
                                                  {40.5135,15.5412},
                                                  {40.2108,15.5224},
                                                  {39.9091,15.5042},
                                                  {39.6083,15.4867},
                                                  {39.3083,15.4697},
                                                  {39.009,15.4534},
                                                  {38.7104,15.4377},
                                                  {38.4124,15.4226},
                                                  {38.1147,15.408},
                                                  {37.8175,15.3941},
                                                  {37.5204,15.3808},
                                                  {37.2236,15.368}};

raw_points_.resize(path.size());
for(std::size_t i = 0; i < path.size(); ++i){
  raw_points_.push_back({optim_path.at(i).first,optim_path.at(i).second});
}

#endif
}

namespace apollo::planning {
void qp_spline_smoother(const std::vector<Eigen::Vector2d> &raw_points_,
                        std::vector<double> &sloveX,
                        std::vector<double> &sloveY) {
  // qp_spline
  std::vector<double> t_knots_;
  uint32_t num_spline = 2;
  for (std::uint32_t i = 0; i <= num_spline; ++i) {
    t_knots_.push_back(i * 1.0);
  }

  uint32_t order = 5;
  OsqpSpline2dSolver spline_solver(t_knots_, order);

  Spline2dConstraint *constraint = spline_solver.mutable_constraint();
  Spline2dKernel *kernel = spline_solver.mutable_kernel();

  std::vector<double> t_coord;
  vector_Eigen<Eigen::Vector2d> ref_ft;
  std::vector<Vec2d> ref_point;
  std::vector<double> ref_x, ref_y;
  std::vector<double> lateral_bound, longitudinal_bound;
  std::vector<double> ref_theta;
  std::vector<double> constraint_x, constraint_y;

  constraint_x.clear();
  constraint_y.clear();

  for (size_t i = 0; i < raw_points_.size(); ++i) {
    constraint_x.push_back(raw_points_.at(i).x());
    constraint_y.push_back(raw_points_.at(i).y());

    t_coord.emplace_back(i * 0.25);
    Vec2d prev_point(constraint_x[i], constraint_y[i]);

    Vec2d new_point = prev_point;
    ref_x.push_back(new_point.x());
    ref_y.push_back(new_point.y());
    ref_point.emplace_back(new_point.x(), new_point.y());
    longitudinal_bound.emplace_back(0.2);
    lateral_bound.emplace_back(0.2);
  }

  for (size_t i = 0; i < constraint_x.size() - 1; ++i) {
    double delta_y = constraint_y.at(i + 1) - constraint_y.at(i);
    double delta_x = constraint_x.at(i + 1) - constraint_x.at(i);
    double theta = calc_point_theta(delta_y, delta_x);
    // std::cout << "theta:" << theta << "\n";
    ref_theta.push_back(theta);
  }

  ref_theta.push_back(
      calc_point_theta(constraint_y.at(constraint_y.size() - 1) -
                           constraint_y.at(constraint_y.size() - 2),
                       constraint_x.at(constraint_x.size() - 1) -
                           constraint_x.at(constraint_x.size() - 2)));

  constraint->Add2dBoundary(t_coord, ref_theta, ref_point, longitudinal_bound,
                            lateral_bound);
  constraint->AddThirdDerivativeSmoothConstraint();
  kernel->AddThirdOrderDerivativeMatrix(200);
  kernel->AddSecondOrderDerivativeMatrix(100);
  kernel->AddDerivativeKernelMatrix(10);

  // 正则化
  kernel->AddRegularization(100);
  constraint->AddPointAngleConstraint(0, 1.45981);
  // TODO(all): fix the test.
  auto start = std::chrono::system_clock::now();
  if (spline_solver.Solve()) {
    std::cout << "solve successful" << std::endl;
  }
  auto end = std::chrono::system_clock::now();
  std::chrono::duration<double> diff = end - start;
  std::cout << "Time to solver is " << diff.count() << " s\n";

  // 提取优化结果
  for (auto const t : t_coord) {
    auto xy = spline_solver.spline()(t);
    sloveX.emplace_back(xy.first);
    sloveY.emplace_back(xy.second);
  }
}
}  // namespace apollo::planning

namespace apollo::planning {
void spiral_smoother(std::vector<Eigen::Vector2d> &raw_points_,
                     std::vector<double> *theta, std::vector<double> *kappa,
                     std::vector<double> *dkappa, std::vector<double> *s,
                     std::vector<double> *spiral_x,
                     std::vector<double> *spiral_y) {
  SpiralReferenceLineSmoother spiral_smoother_;
  spiral_smoother_.SmoothStandAlone(raw_points_, theta, kappa, dkappa, s,
                                    spiral_x, spiral_y);
}
}  // namespace apollo::planning

namespace apollo::planning {
using namespace reference_line;

void hermit_spiral(std::vector<double> &raw_xs, std::vector<double> &raw_ys,
                   std::vector<double> &sloveX, std::vector<double> &sloveY) {
  CurveCreator creator(raw_xs, raw_ys);
  creator.solve();
  auto &curve = creator.curve();

  double length = curve->length();

  // constexpr int N = 44;
  int N = raw_xs.size() - 1;

  double stride = length / N;

  for (double i = 0; i < N + 1; i++) {
    sloveX.emplace_back(curve->x(i * stride));
    sloveY.emplace_back(curve->y(i * stride));
  }
}
}  // namespace apollo::planning

int main() {
  std::vector<Eigen::Vector2d> raw_points_;
  SetPoints(raw_points_);
  std::vector<double> ref_x, ref_y;
  ref_x.reserve(raw_points_.size());
  ref_y.reserve(raw_points_.size());
  for (const auto &item : raw_points_) {
    ref_x.emplace_back(item.x());
    ref_y.emplace_back(item.y());
  }
//    read_csv(raw_points_);
#if 1
  std::vector<double> theta;
  std::vector<double> kappa;
  std::vector<double> dkappa;
  std::vector<double> s;
  std::vector<double> spiral_x;
  std::vector<double> spiral_y;
  std::vector<double> spiral_final_kappas, spiral_final_dkappas;
  spiral_smoother(raw_points_, &theta, &kappa, &dkappa, &s, &spiral_x,
                  &spiral_y);
  cal_path_kappa(spiral_x, spiral_y, spiral_final_kappas, spiral_final_dkappas);
  plt::subplot(2, 2, 1);
  plt::named_plot("refrenceline_XY", ref_x, ref_y);
  plt::named_plot("spiral_ipopt_xy", spiral_x, spiral_y);
  plt::axis("equal");
  plt::legend();
  plt::subplot(2, 2, 2);
  // plt::named_plot("spiral_dkappa", dkappa,"r");
  plt::named_plot("spiral_kappa", kappa);
  plt::legend();
#endif
  /************************************************************************/
#if 1
  std::vector<double> sloveX, sloveY, qp_final_kappas, qp_final_dkappas;
  qp_spline_smoother(raw_points_, sloveX, sloveY);
  cal_path_kappa(sloveX, sloveY, qp_final_kappas, qp_final_dkappas);
  plt::subplot(2, 2, 3);
  plt::named_plot("refrenceline_XY", ref_x, ref_y);
  plt::named_plot("qp_spline", sloveX, sloveY);
  plt::axis("equal");
  plt::legend();
  plt::subplot(2, 2, 4);
  plt::named_plot("qp_kappa", qp_final_kappas);
  // plt::named_plot("qp_dkappa", qp_final_dkappas,"r");
  plt::legend();

#endif

  /************************************************************************/
#if 0
     std::vector<double> raw_xs, raw_ys;
     div_circle(raw_xs, raw_ys, 5, 1);
  
     std::vector<double> hermit_sloveX, hermit_sloveY;
     hermit_spiral(raw_xs, raw_ys, hermit_sloveX, hermit_sloveY);
     plt::named_plot("hermit_spiral_ceres", hermit_sloveX, hermit_sloveY);
#endif
  /************************************************************************/

  // write_to_csv(spiral_x, spiral_y);

  plt::show();

  return 0;
}