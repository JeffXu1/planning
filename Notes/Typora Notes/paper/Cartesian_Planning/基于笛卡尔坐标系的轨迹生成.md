# Autonomous Driving on Curvy Roads Without Reliance on Frenet Frame: A Cartesian-Based Trajectory Planning Method

## Abstract

​		 弯道是一种特殊的城市道路场景，其中道路中心线的曲率变化很大。本文主要研究在弯道上自主驾驶的轨迹规划任务。目前流行的Frenet框架下的道路轨迹规划器不能对轨迹曲率进行准确的限制，因此很容易使产生的轨迹超出自我车辆的运动能力。关于笛卡尔坐标系下的规划，基于采样选择的方法受到维度爆炸的影响。相比之下，笛卡尔坐标系下的基于优化的方法更灵活，可以在连续的解空间中找到最优值，但新的挑战是如何解决难以解决的避撞约束和非凸的运动学约束。我们提出了一个迭代计算框架来累积处理这些复杂的约束。具体来说，在每次迭代中都要解决一个中间问题，其中包含线性和可扩展的避撞约束和软化的运动约束。与现有的基于优化的规划器相比，我们的建议对初始猜测不太敏感，特别是当它在运动学上不可行的时候。我们提出的计划器的效率通过模拟和现实世界的实验得到了验证

## INTRODUCTION

### **基于Frenet坐标系优劣**

- 优势
  - 任何道路都可以被标准化为具有左右边界的直行隧道。这样一来，轨迹规划问题中的非线性避撞约束就转化为线性隧道内约束。除此之外，原来耦合的运动学约束被解耦为纵向和横向的独立多项式。
    - 上述特点使基于Frenet的方法能够将轨迹规划方案描述为一个二次方程序（QP），可以快速求解

- 劣势

  - 无法对自我车辆的真实运动学进行建模
    - 基于Frenet的规划者不知道车辆的实际运动能力，因此很容易导致违反轨迹曲率限制

  - 对车辆形状变形的忽视

  - 无法确保轨迹的连续性

  - 无法支持多车辆合作规划

总结：基于Frenet的规划器不适合在弯曲的道路上进行轨迹规划

### 基于笛卡尔坐标系规划的挑战

1. 由于弯曲道路上的可驾驶区域不再是一个简单的左右界限的标准化隧道，所以导致笛卡尔坐标系下的避撞约束要远比Frenet框架下的复杂

   **解决办法**：

   业内通常的做法是建立时空安全走廊，通过走廊内的约束条件来开辟避免碰撞的约束空间

   **问题**：

   ①走廊构建策略都不可避免地遗漏了部分可驾驶区域，因此，如果遗漏的区域对于运动学的可行性来说是必要的，那么解决方案就会失败

   ②廊内约束的正确性在很大程度上依赖于参考轨迹的质量。如果参考轨迹远离运动学上的可行性，那么OCP（OCP ：**on-road trajectory planning task** ）很容易变得不可行

2. 基于笛卡尔的运动学约束的非凸性，这在很大程度上拉低了OCP的求解速度

   **解决办法：**

   ①假设曲率曲线是一个参数化的立方样条，从而简化了运动学约束

   **问题：**然而，使用指定样条来描述 OCP 中的状态/控制配置文件会降低规划的灵活性，从而容易导致解决方案失败。

   ②建立了一个迭代框架，其中带有线性化运动学约束的QP问题被反复求解；在一次迭代中得出的最优值作为下一次迭代的一阶泰勒扩展点；用松弛变量放松防撞约束，同时要求最小化松弛变量；迭代持续到收敛。

   **问题：**这种方法的效率高度依赖于良好的一阶泰勒扩展点，如果没有，中间的QP问题就变得不可行，从而终止整个迭代过程

总结：笛卡尔坐标系中最先进的基于优化的规划器在处理弯曲的道路情况时仍然不完美。

### 本文创新点

1. 提出了一个迭代计算框架。与笛卡尔坐标系内现有的基于优化的轨迹规划方法相比，保证了走廊内的约束是线性的、可扩展的、对参考轨迹不敏感的，并且对可驾驶区域有足够的覆盖。
2. 简化了非凸的运动学约束，并且不违反这些约束或使规划者依赖于初始猜测。
3. 本文提出的方法以综合方式处理这两个挑战，而不是提出两个单独的策略

## PROBLEM STATEMENT

### 整体方案

$$
Minimize\ \ J(x(t),u(t)) \\
s.t.\ \dot{x}=f_{kinematics}(x(t),u(t)), \\
x ≤ x(t) ≤  \bar x, u ≤ u(t) ≤ \bar u ,t \in [0,T] \\
x(0) = X_{init}, u(0) = U_{init}, x(T) = x_{goal}, u(T) = U_{goal},\\
h_{collision}(x(t)) \leq 0, \ t \in [0, T].
$$

> $x(t)$ 表示笛卡尔坐标系中的状态轮廓。具体来说，它代表$[x(t), y(t), θ(t), v(t), a(t), φ(t)]$，其中$(x(t), y(t))$表示自车上参考点的位置（参考点设置为后桥中点），
>
> $θ(t)$表示车辆的方位角，$v(t)$为纵向速度，$a(t)$为加速度，φ(t)为转向角。
>
> $u(t)$表示笛卡尔坐标系中的控制曲线$[jerk(t),ω(t)]$，其中$jerk(t)$是$a(t)$的导数，$ω(t)$是角速度$φ(t)$。
>
>  $f_{kinematics}= 0 $等式来描述车辆运动学。 $h_{collision} \leq 0$ 代表碰撞避免约束。$ [x, \bar x, u, \bar u]$ 表示边界范围
>
>  $T$ 表示规划周期

### 优化变量

$$
q = [x,y,\theta,v,\varphi,a,\omega,jerk,x_{front},y_{front},x_{rear},y_{rear}]
$$

### cost function

$$
J(x(t),u(t)) = \int_{t=0}^{T}(\lVert x(t)-x_{ref}(t)\rVert^2 + W_u \lVert u(t)\rVert^2)\cdot dt
$$

> 其中,$W_u$表示加权系数，
> $$
> \lVert x(t)-x_{ref}(t)\rVert^2 =(x(t)-x_{ref}(t))^2+(y(t)-y_{ref}(t))^2 + W_{r\theta}\cdot(\theta(t)-\theta_{ref}(t))^2 \\
> \lVert u(t)\rVert^2 = jerk^2(t) + W_{rw}\cdot w^2(t)
> $$

### 约束

![Screenshot from 2022-10-22 16-10-47](/home/next/routing_planning/Notes/Typora Notes/paper/Cartesian_Planning/Screenshot from 2022-10-22 16-10-47.png)

1. *Kinematic Constraints*
   $$
   \frac{d}{dt}
   \begin{bmatrix} 
   		x(t) \\ y(t) \\ \theta(t) \\ v(t) \\ \varphi(t) \\ a(t) 
   \end{bmatrix} = 
   \begin{bmatrix}
   		v(t)\cdot cos\theta(t) \\ v(t)\cdot sin\theta(t) \\ v(t)\cdot tan\varphi(t)/L_w \\ a(t) \\ jerk(t) 
   \end{bmatrix},t \in [0,T]，其中，L_w为轴距
   $$
   
   $$
   \begin{bmatrix} 
   		a_{min} \\ 0 \\ -jerk_{max} \\ -\Omega_{max} \\ -\Phi_{max}
   \end{bmatrix} \leq
   \begin{bmatrix}
   		a(t) \\ v(t) \\ jerk(t) \\ w(t) \\ \phi(t)
   \end{bmatrix} \leq
   \begin{bmatrix} 
   		a_{max} \\ 0 \\ -jerk_{max} \\ -\Omega_{max} \\ -\Phi_{max}
   \end{bmatrix} \leq,t \in [0,T]
   $$
   
1. *Two-Point Boundary Constraints*
   
   $t=0时$：
   
   ​		$[x(0),y(0),\theta(0),v(0),a(0),jerk(0),\phi(0),w(0)] = [x_0,y_0,\theta_0,v_0,a_0,jerk_0,\phi_0,w_0]$

   $t=T$时：
   
   ​		$[a(T), jerk(T), ω(T)] = [0,0,0]$
   
3. *Collision-Avoidance Constraints*

   基于矩形框来建立碰撞约束会超出基于梯度的OCP求解能力，故建立时空走廊，以此开辟一个凸空间进行最优求解

   ![Screenshot from 2022-10-22 15-56-08](/home/next/routing_planning/Notes/Typora Notes/paper/Cartesian_Planning/Screenshot from 2022-10-22 15-56-08.png)

$$
xlb_{i}^{j}  \leq x^{discj}(t) \leq xub_{i}^{j},\\
ylb_{i}^{j}  \leq y^{discj}(t) \leq yub_{i}^{j},\\
t \in [t_i,t_{i+1}], i =0,..., N_{FE}−1, j =1,..., N_{DISC}
$$

矩形车身被$ N_{DISC}$ 同半径圆盘均匀覆盖，其中$ (x^{discj}, y^{discj} ) $表示第 $j$个圆盘中心的位置。则$ (x^{discj}, y^{discj} ) $定义为
$$
x^{discj}(t) = x(t) + (\frac{2j-1}{2N_{DISC}}\cdot(L_R+L_w+L_F)-L_R)\cdot cos\theta(t)\\
y^{discj}(t) = y(t) + (\frac{2j-1}{2N_{DISC}}\cdot(L_R+L_w+L_F)-L_R)\cdot sin\theta(t)\\
j = 1,\ldots,N_{DISC},T \in [0,T]
$$
每个圆盘的半径为
$$
R^{disc}=\sqrt{(\frac{L_R+L_W+L_F}{2N_{DISC}})^2 + (\frac{L_B}{2})^2} 
$$
时间满足
$$
t_0 = 0, t_{NFE} = T,t_{i+1} − t_i = T/N_{FE}, ∀i = 0,..., N_{FE} − 1.
$$
一般来说，轨迹规划就是要解决运动学相关约束和环境相关约束之间的潜在冲突。然而，OCP（12）中的走廊内约束*Collision-Avoidance Constraints*是有问题的，因为它是根据粗略搜索过的参考轨迹制定的，容易遗漏运动学可行性所需的自由空间。因此，直接求解OCP并不总是有效。另一个思路是建立**一个迭代框架**，如果发现走廊内约束*Collision-Avoidance Constraints*不合适，就对其进行适应性调整。

### TRAJECTORY PLANNING METHOD

![Screenshot from 2022-10-22 16-47-13](/home/next/routing_planning/Notes/Typora Notes/paper/Cartesian_Planning/Screenshot from 2022-10-22 16-47-13.png)

中间迭代过程的OCP为：
$$
Minimize \ \ J(x(t),u(t)) + W_{penalty}.f_{penalty}(T), \\
s.t. \ \ x ≤ x(t) ≤  \bar x, u ≤ u(t) ≤ \bar u ,t \in [0,T] \\
x(0) = X_{init}, u(0) = U_{init}, x(T) = x_{goal}, u(T) = U_{goal}
$$
其中：
$$
J(x(t),u(t)) =\int_{t=0}^{t}((x(t)-x_{ref}(t))^2+(y(t)-y_{ref}(t))^2 + W_{r\theta}\cdot(\theta(t)-\theta_{ref}(t))^2  + \\ jerk^2(t) + W_{rw}\cdot w^2(t) \cdot) dt\\
f_{penalty}(t) = \int_{t=0}^{t}(\lVert \dot x(t)-f_{kinematics}(t)\rVert^2 +  \lVert g_{disc}(t)\rVert^2)\cdot dt \\
式中，车辆运动学约束被抽象为\dot x(t)＝f_{kinematics}(t)，而圆盘中心定义被抽象为g_{disc}(t)＝0。
$$
详细过程包括为：

1. 通过$FormInitialGuess()$生成一个初始值，加载通过采样和搜索得到的参考轨迹$trajcoarse$，然后返回数值求解所需的所有决策变量

2. 循环

   1. 函数$FormulateIntemediateOCP()$被用来生成一个中间OCP
   2. $SolveNLP(OCP,x)$用热启动初始猜测值 $χ$ 求解公式化的中间 OCP
      1. 将 OCP 离散为一个非线性程序 $NLP$ 问题
      2. 通过一个基于梯度的局部优化器进行求解
      3. 其中的最优值作为初始值供下一个迭代使用
   3. $MeasureInfeasibility()$输出$f_{penalty}(t)$得到运动学不可行性度
   4. 当$f_{penalty}(t)$足够接近于0时，$ExtractTrajectoryFromSolutionVector(χ)$从解决方案向量中获得轨迹，否则更新$w_{penatly}$


###  EXPERIMENTAL RESULTS AND DISCUSSIONS

### APPENDIX A

在Frenet框架中对轨迹规划问题建模的缺陷

1. 过度依赖参考线

   Frenet框架的建立依赖于参考线来反映道路趋势。参考线应该是曲率连续的；否则，即使是在 Frenet 坐标系中导出的曲率连续轨迹在转换回笛卡尔坐标系后也会变得曲率不连续
   $$
   κ_x =  
   \begin{Bmatrix}
   \frac{[k_f+(k_r^,l+k_rl^,)tan\Delta\theta]cos^2\Delta\theta}{1-k_rl} + κ_r 
   \end{Bmatrix}\cdot\frac{cos\Delta\theta}{1-k_rl}
   $$
   假设一条轨迹在 Frenet 坐标系中的曲率是 $κ_f$，在轨迹转换回笛卡尔坐标系后曲率变为 $κ_x$，他们之间转换关系如上式，可以得知$k_x$由$k_r$和$k_f$所决定，因此如果$k_r$s是不连续的，那么无论$k_f$是否连续，$k_x$都是不连续的。

2. 从笛卡尔坐标系到Frenet坐标系的转换不一致

   ![Screenshot from 2022-10-23 11-53-24](/home/next/routing_planning/Notes/Typora Notes/paper/Cartesian_Planning/Screenshot from 2022-10-23 11-53-24.png)

   所有标记为红色的映射点同样最接近$P_0$，这导致在转换为Frenet坐标系时难以确定$P_0$的s值。

   即使转换是唯一的，Frenet框架也是不完美的。$P_1$和$P_2$在笛卡尔坐标系中距离很近，但它们的s值却相差很大，这意味着笛卡尔坐标系中的空间连续轨迹在转换为Frenet坐标系时将变得不连续。

   总而言之，**从笛卡尔坐标系到弗里内特坐标系的映射既不唯一也不均匀，从而使转换不稳定**。

3. 车辆形状失真

   ![Screenshot from 2022-10-23 12-07-56](/home/next/routing_planning/Notes/Typora Notes/paper/Cartesian_Planning/Screenshot from 2022-10-23 12-07-56.png)

   当笛卡尔坐标系中的道路标准化为 Frenet 坐标系中的管道时，自车辆的形状在框架转换后将不再是矩形。如果道路弯曲，两个坐标系之间的间隙会很大。当前研究这个问题的人较少。

4. 无法支持协同规划

   由于Frenet坐标系是沿单一参考线构建的，如果多辆车的参考线不同，它就不能支持多辆车的协同规划。因此，在 Frenet 框架中无法实现主流的智能交通功能，例如协同变道和自主交叉口管理。

### APPENDIX B

构建时空走廊原理

![Screenshot from 2022-10-23 14-08-43](/home/next/routing_planning/Notes/Typora Notes/paper/Cartesian_Planning/Screenshot from 2022-10-23 14-08-43.png)

![Screenshot from 2022-10-23 14-09-00](/home/next/routing_planning/Notes/Typora Notes/paper/Cartesian_Planning/Screenshot from 2022-10-23 14-09-00.png)

> 参考这篇论文：
>
> [Maneuver Planning for Automatic Parking with Safe Travel  Corridors: A Numerical Optimal Control Approach](https://ieeexplore.ieee.org/document/9143786)

本文解释：

![Screenshot from 2022-10-24 10-56-52](/home/next/routing_planning/Notes/Typora Notes/paper/Cartesian_Planning/Screenshot from 2022-10-24 10-56-52.png)

### CONCLUSION

本文提出了一种基于笛卡尔坐标系优化的弯道自动驾驶轨迹规划方法。与运行速度快但无法准确反映车辆运动学的流行的基于 Frenet 的规划器相比，我们提出的规划器在自车实际的真实世界笛卡尔坐标系中对车辆运动学和碰撞约束建模。笛卡尔坐标系的选择呈现了几个提出的迭代优化框架系统地解决了问题制定和问题解决过程中的挑战。。

仿真结果表明：

1. Frenet框架在描述车辆运动学方面有其局限性
2. 如果设计合理，基于笛卡尔的规划器有希望迅速提供准确的解决方案
3. 主要的优化促进策略通常涉及凸化或通过泰勒扩展点进行线性化，但在运行时间上并不完美。

这里值得强调的是，基于Frenet的规划器在描述道路上与交通规则相关的约束方面确实有其天然的优势，而对基于笛卡尔的规划器来说，为这些约束建模并不容易。我们未来的工作重点是如何在基于笛卡尔的轨迹规划器中描述空间约束的公路自动驾驶场景。此外，还应该开发一种统一的方法，**将笛卡尔和 Frenet 坐标系整合在一起，并随着道路场景的变化在它们之间进行自适应的切换**
