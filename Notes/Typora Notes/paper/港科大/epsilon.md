# (2021)EPSILON: An Efficient Planning System for Automated Vehicles in Highly Interactive Environments (EPSILON：面向环境交互的高效规划系统)

![image-20220505091625724](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/image-20220505091625724.png)![image-20220505143953698](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/image-20220505143953698.png)

## 1 相关工作

### 1.1 自动驾驶汽车行为规划

- **基于状态机的行为规划**

  - 它采用针对不同驾驶条件的手工规则。该方法根据输出状态和动作，提取参考路径并提供给运动规划层。但由于实际驾驶的复杂性，需要持续的工程和调优工作来维护状态机。
  - 采用纯几何推理的方法来假设其他交通参与者的确定性轨迹预测，以实现碰撞检查。

  然而，在现实驾驶中，**由于预测问题的多模态和不确定性，预测应该从概率的角度建模**。此外，被控车辆未来的不同动作可能会导致未来的不同情况，这也不能单纯用几何推理来建模。

- **基于多智能体交互的行为规划**

  多智能体交互多基于POMDP方法来展开，但存在维度爆炸的问题，在决策规模扩大时，会变得非常难以求解，在解决计算问题上除了开发新的在线POMDP求解器，通常的做法是用领域知识来简化原始的POMDP，一种代表性的做法是MPDM，MPDM 将原始问题转化为在有限数量的策略中选择具有最高奖励的最佳策略，计算效率高且易于部署。然而，MPDM 过度简化了自我车辆的动作：**每个候选策略仅包含一个持续时间较长的语义级动作**，使得 MPDM 成为单阶段 MDP，这限制了决策的可操作性和“智能”水平。

  本文，**保留了 POMDP 的多层结构，并利用领域知识和引导分支来实现更高的效率，同时保持灵活性.**

### 1.2 自动驾驶运动规划

ssc 时空语义走廊（略）

## 2 问题建模

定义 $POMDP$ 模型元组$(X,A,Z,T,O,R)$

- $X、A、Z$ 分别为为状态空间、动作空间、观测空间

- $T(x_{t-1},a_t,x_t) = p(x_t|x_{t-1},a_t)$ 为概率转移模型，反应概率状态

  $O(x_t,z_t) = p(z_t|x_t)$ 为观测模型，反应不确定性感知

- $R(x_{t-1},a_t)$ 为奖励函数，$X \times A\rightarrow R$ ，其中$a_t \in A$，$x_{t-1} \in X$

由于无法观测到真实世界中的某些状态，故采用信念 $b$来表述目标在状态空间$X$上的概率分布，其中 $b \in B$，我们可以在智能体离开信念  $b_{t-1}$ ，然后执行行动 $a_t$ 并接受观察 $z_t$ 后，利用贝叶斯估计来推测信念状态：
$$
b_{t}(x_t)=p(x_t|z_t,a_t,b_{t-1}) 
= \eta O(x_t,z_t) \int_{x_{t-1 \in X}} T(x_{t-1},a_t,x_t)b_{t-1}(x_{t-1})dx_{t-1}
$$

> 信念状态指智能体对目前环境所处状态的概率估计，是所有过去观察、行动历史的统计充分量，记信念状态为 $b$，则 $b(s)$ 给出当前环境处于状态 $s$ 的概率，即$ b(s) = P_r(s | b)$。给 定初始信念状态$ b_0$ 和观察—行动历史 $h = (a_0, o_1, a_1, o_2, . . . a_{t−1}, o_t)$，则当前 的信念状态可以递归地根据贝叶斯推理方法唯一确定，即：
> $$
> b^{'}(s^{'}) = \eta \Omega(o|s^{'},a)\sum_{s \in S}T(s^{'}|s,a)b(s)
> $$
> 其中，$\eta = 1 / P(o|b,a)$ 是一个正则化因子，展开为：
> $$
> \eta = \frac{1}{\sum_{s\in S^{'}}\Omega(o|s^{'},a)\sum_{s\in S}T(s^{'}|s,a)b(s)}
> $$
> 公式(1)即完成了信念状态的更新，以可以写成关于 b，a 和 o 的函数形式： $b^′ = ζ(b, a, o)$。$ζ$函数一般被称为**贝叶斯滤波器（Bayesian Filter）**。令 $B $为所有信念状态的集合——即信念空间，则 POMDP 的策略 $π$ 定义成 信念空间到动作空间的映射，即 $π : B → A$。

 $POMDP$ 是找到一个最优策略  $π ∗$ ，它将信念状态映射到一个动作 $π : B → A$，在规划周期内使期望奖励最大化：
$$
π^∗ := \underset{\pi}{argmax}\mathbb{E}   \biggr[\sum\limits^{^t_H}_{t=t_0} \gamma^{t-t_0}R(x_t,\pi(b_t)) |b(t_{t_0})  \biggr]
$$
其中：$t_0$ 为当前规划时间，$\gamma \in [0,1] $ 为折扣因子。

从初始信念 $ b_{t_0}$ 开始，在动作空间 $A $和观察空间 $Z $中扩展，直到某个规划范围 $t_H$，逐个节点构建信念树。然后，通过在每个内部节点上应用贝尔曼方程来找到最优策略：
$$
\begin{equation*}
  \begin{aligned}
    V^∗(b) &= \underset{a\in A}{max}Q^∗(b, a)\\
    &= \underset{a\in A}{max} \biggl[ \int_{x\in X}b(x)R(x,a)dx + \gamma \int_{z\in Z} P(z|b,a)V^*(\tau(b,a,z)dz) \biggl]
  \end{aligned}
\end{equation*}
$$
其中：其中$ V^∗ (b) =\int_{s \in S} V^∗(s)b(s)ds$ 是信念状态的最优效用函数，$Q^∗(b, a)$ 描述了信念-动作对的最优值。

最后，提取完整的轨迹线 $S_t = [b^∗_t , a^∗_{t+1}, z^∗_{t+1}, b^∗_{t+1}, ..., b^∗_{t+H}]$，其中，
$$
a^∗_t = \underset{a_t \in A}{argmax}Q^*(b_{t-1},a_t) \\
z^∗_t = \underset{z_t \in Z}{argmax}p(z_t|b_{t-1},a^*_t)
$$


------



# (2020)Efficient Uncertainty-aware Decision-making for Automated Driving Using Guided Branching (基于导向分支的高效不确定性自动驾驶决策)

## 1  框架

![Screenshot from 2022-11-02 09-32-38](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/Screenshot from 2022-11-02 09-32-38.png)

这篇文章没有使用学习算法，重点是基于经验的抽象和剪枝。

蓝色框部分主要是一个部分可观测的马尔科夫模型(POMDP), 核心单元有三，第一个表征是本体决策序列的DCP-Tree, 第二个是对重点车辆的行为进行穷举的CFB， 第三个是每个被穷举场景的仿真

1. **Domain-specific Closed-loop Policy Tree (DCP-Tree)**

   作者设计了一个8s的planning horizon,每2s为一个policy更新的节点，所以DCP树的深度为4。作者进一步考虑了一个剪枝方法，作者认为每个规划周期中，只会发生一次策略更新，如果需要复杂的规则变化(lane-keep -> lane-change -> lane-keep),则**可以通过高频率的重新规划实现**。

2. **Conditional Focused Branching (CFB)**

   作者的设计是穷举相关车辆的所有intention， 但是这个"相关"车辆是由本车的决策决定的。比如左转的时候会仅考虑本线以及左侧的车辆，限制了搜索的agent数量。

3. **内部开环或闭环仿真**

   作者在法向方向对其他车辆的控制算法是pure pursuit controller, 沿线方向的控制逻辑为 [IDM](https://www.wikiwand.com/en/Intelligent_driver_model)

### 1.1 DCP-tree

① **传统的PDM有两个明显的问题：**

- 一个是对本车行为的采样是单一的，一次时间序列的采样中只有一个选项，这就没法表示先直行后变道的连续变化动作，如果采用MPDM方案(左图)，在左侧也有车辆的情况下一样会变道；而此时需要的应该是一个先直行超过左边的车，然后再执行变道的连续动作，现在为了实现时间序列上的多个动作，势必需要更多的采样组合，这就增加了资源消耗
- MPDM的另一个问题就是时间序列过程中没有交互，这里的交互指的是其他车辆受到的周围环境的影响。作者指出，特别在起始状态下预测有偏差的时候，这个不交互的假设还是有风险的

![Screenshot from 2022-05-09 00-38-01](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/Screenshot from 2022-05-09 00-38-01.png)

> - 左图(MPDM方案)表示在规划周期内预测的行为是固定的，所以只有当自车超过左边红色车辆才进行换道
> - 右图表示提前对前方车辆做出判断，所以在未超过左边红色车之前就执行换道策略，考虑了未来时刻的交通参与者的行为变化

② **dcp-tree优化资源消耗，基本的原则为：**

- 时间序列上根据语义动作限定树的branching，比如说，当前动作是左变道，接下来的动作中右变道肯定是非法的
- 每个动作序列中，只允许行为变化一次，比如直行-直行-左变道。通过上述两个方案大幅度减少本车的动作采样的数量

![Screenshot from 2022-05-06 10-28-17](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/Screenshot from 2022-05-06 10-28-17.png)

> 注：
>
> - $(a1,a2,a3)$表示离散语义级操作可以理解为 $(LK-LC-LC-LC. . .), (LK-LK-LC-LC. . .) $和 $(LK-LK-LK-LC. . .)$，这里的$LK,LC$是加入了人类的先验知识做出的行为策略
> - 横向作用定义为 $(LK，LCL，LCR)$
> - 纵向动作定义为 $(加速，保持速度，减速)$

### 1.2 CFB

conditional focused branching则是提供了时间序列上其他车辆与环境的交互来避免可能存在的风险。当然为了保证实时性要求，不可能直接一个马尔可夫全状态空间都走一遍。

**执行步骤：**

1. 选择本车周围的感兴趣障碍物

2. 根据障碍物的初始预测信息进行开环仿真，看看这个障碍物到底有没有和其他车会产生碰撞风险。并且这里假设这辆车不与其他车产生交互动作

   - 如果开环仿真通过了安全评估，说明这个车对于我们很安全，完全不需要花费太多资源对它进行不可行性推断。这个时候，直接用初始状态时对这辆车的预测信息已经完全够用了
   - 如果没通过安全评估，则说明这辆车可能还是对本车有风险的，这时候采用闭环仿真方式再进行一轮评估，这次的假设是考虑车辆与环境交互的，注意目标车辆的评估也并不是全空间拓展的，依旧使用上面的DCP-Tree来拓展目标车状态从而实现大幅剪枝

   ![Snipaste_2022-05-05_22-16-15](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/Snipaste_2022-05-05_22-16-15.jpg)

3. 在获得了所有的本车与环境交互方案之后以一个目标函数进行评估，给出最优的结果

   > 具体评估的就是考虑安全和效率的一些目标函数，同时这部分可以用基于学习的方案来进行。也可以基于规则的专家调参方案(**评估策略引入了RSS模型**)。
   >
   > The reward function consists of three parts :
   >
   > - efficiency:  效率（由当前速度和期望速度之间的差异衡量）
   > - safety:安全（由我们的车辆和周围车辆之间的距离衡量）
   > - navigation:  一致性（由最后的最佳策略和要评估的策略之间的差异衡量）
   >
   > 并行计算的部分:
   >
   > - Evaluation for each policy sequence
   > - forward simulation

### 1.3 DCP + CFB整体流程

![Screenshot from 2022-11-02 10-42-04](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/Screenshot from 2022-11-02 10-42-04.png)

**流程：**

1. DCP决策树用于指导操作域中的分支，并基于之前的最佳策略更新语义级策略树

2. CFB机制用于识别附近车辆的危险隐藏意图

3. 通过闭环模拟对每个场景进行评估(考虑代理之间的交互)

4. 将所有场景都被输入到成本评估模块，并对风险分支机构应用有偏惩罚

5. 闭环正向仿真生成的一系列离散车辆状态(实验中分辨率为0.4s)

   正向模拟闭环模拟是在考虑潜在交互的**同时向前推进多智能体系统的状态**。仿真模型应在仿真逼真度和推理效率之间实现良好的平衡。分别采用**智能驾驶模型(IDM)**和**纯追踪控制器**作为纵向和横向仿真模型。

   当前的方法是基于规则生成动作引导，也就是加入**人工和专家知识**，预制多种最优解以应对不同的状况，POMDP仅需要挑选对应目前状况最优的一个policy即可，但难以涵盖所有的状况，后面改用基于模仿学习的方式

6. 将状态序列传入运动规划器，以指导轨迹生成过程

## 2 难点

### 2.1 要解决的问题

- 如何把环境中的**其他交通参与者的潜在随机行为**和**感知不确定性**考虑到决策系统中？

   `POMDP`模型框架有完整的理论基础来解决这类问题

- 如何处理真实世界中**维度爆炸**的问题？

   核心思想：利用特定领域的专家知识来引导行为空间和意图空间的分支，就是对问题进行剪枝处理

   - 时间序列上根据语义动作限定树的branching，比如说，当前动作是左变道，接下来的动作中右变道肯定是非法的。
   - 每个动作序列中，只允许行为变化一次，比如直行-直行-左变道。通过上述两个方案大幅度减少本车的动作采样的数量。

   <img src="/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/image-20220506163430129.png" alt="image-20220506163430129" style="zoom: 67%;" />

   

### 2.2 解决方案

提出了一种高效的**不确定性感知决策框架(EUDM)**，该框架可实时生成复杂驾驶环境下的长期横向和纵向行为。通过领域特定的闭环策略树(DCP-Tree)结构采样本车时间序列动作并进行减枝，然后通过条件聚焦分支(CFB)机制进行开环或闭环评估，最后选择最优序列。

## 3 related works

**不确定感知决策(EUDM)框架**

1. 使用特定于领域的闭环策略树(DCP-Tree)来构造语义层的操作空间

2. 策略树中的每个节点都是自车的有限范围语义行为

3. 从根节点到叶节点的每个轨迹代表了自车的语义动作序列

   ![Screenshot from 2022-05-06 10-28-17](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/Screenshot from 2022-05-06 10-28-17.png)

4. 每个轨迹以闭环模拟的形式进行评估，但自我行为允许在规划范围内更改(**评估策略引入了RSS模型**)

### 3.1 预测和规划解耦带来的问题

1. **自车和他车的交互问题**，这一个周期(8s)内自车和他车都在运动，而预测和规划分离却认为预测结果在一个周期内是固定不变的，灵活性不高

2. 考虑到车载传感器不完善的跟踪可能会导致**预测错误**，从而影响决策的安全性和通行效率

   当前环境感知系统不太准确，导致预测模块(意图与轨迹)结果不准确，导致自车与目标博弈算法失败，使得决策系统更倾向于保守的规则(停车)。比如评估当前场景变化莫测，系统很难避障，系统就会选择停车，而如果与后车间距又太小，就会一直等着，直到前方可通行

3. 假设完美的感知，预测仍然会存在很多**不确定性**(例如鬼探头，行人过马路)

### 3.2 环境不确定性解决方案

**引入POMDP模型框架来解决上述问题**

> 部分观测马尔科夫决策过程（Partial Observable Markov Decision Process, POMDP）能提供理论上最优的解决方案，即在考虑多车相互影响的不确定性前提下，提供最优的决策和规划。

1. DCP决策树用于指导操作域中的分支，并基于之前的最佳策略更新语义级策略树

2. CFB机制用于识别附近车辆的危险隐藏意图

3. 通过闭环模拟对每个场景进行评估(考虑代理之间的交互)

4. 将所有场景都被输入到成本评估模块，并对风险分支机构应用有偏惩罚

5. 闭环正向仿真生成的一系列离散车辆状态(实验中分辨率为0.4s)

   正向模拟闭环模拟是在考虑潜在交互的**同时向前推进多智能体系统的状态**。仿真模型应在仿真逼真度和推理效率之间实现良好的平衡。分别采用智能驾驶模型和纯追踪控制器作为纵向和横向仿真模型。

   当前的方法是基于规则生成动作引导，也就是加入**人工和专家知识**，预制多种最优解以应对不同的状况，POMDP仅需要挑选对应目前状况最优的一个policy即可，但是但难以涵盖所有的状况，后面改用基于模仿学习的方式

6. 将状态序列传入运动规划器，以指导轨迹生成过程

<img src="/home/next/.config/Typora/typora-user-images/image-20220505011406682.png" alt="image-20220505011406682" style="zoom: 67%;" /> 

![Snipaste_2022-05-05_22-16-15](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/Snipaste_2022-05-05_22-16-15.jpg)



## 4 实现细节

### 4.1 Semantic-level Actions 语义级操作

考虑横向和纵向行动

- 将横向动作定义为 {LK, LCL, LCR}

- 将纵向动作定义为 {加速，保持速度，减速}

  > 这些纵向动作不是离散控制信号，而是应用于正向仿真模型的连续期望速度

每个语义级动作的持续时间为 2 秒，而闭环模拟以 0.4 秒的步长进行，以保持模拟保真度。每个计划周期的重新计划分辨率 (0.05 s) 会扣除正在进行的行动的持续时间。 DCP-Tree 的深度设置为 4，因此可以获得了8 秒的规划时长。

### 4.2 Forward Simulation 正向模拟

闭环模拟的目标是在考虑潜在交互的同时推动多智能体系统的状态向前发展。为保证保真度和仿真效率：

- 横向采用纯跟踪控制器
- 纵向采用智能驾驶模型(IDM)

### 4.3 Belief update 信念度更新

考虑的他车的隐藏意图包括横向行为，例如 {LK, LCL, LCR}。在前向模拟过程中更新了对代理车辆这些意图的信念。在这项工作中，我们采用基于规则的轻量级信念跟踪模块，该模块采用一组特征和指标，包括速度差、距离 w.r.t。当前和相邻车道上的领先和跟随代理，责任敏感安全（RSS）[31]和车道变换模型[32]作为输入2。信念跟踪器生成意图的概率分布（即 LK、LCL、LCR）。概率作为策略评估期间的重要性权重。

指标：速度差、距离

输入：自车、他车、RSS、换道模型

输出：意图的概率分布(LK,LCL,LCR)

### 4.4 CFB机制

运行步骤：

1. 关键车辆的选择

   对于当前车道和相邻的车道，沿着车道向前和向后搜索一定的距离（相对于自我车辆的当前速度），在此范围内的车辆被标记为关键车辆

2. 根据初始信念选择不确定的车辆

   挑选出三个意图的概率相近的车辆作为不确定车辆。对于具有自信预测的车辆，我们选择 MAP 意图并使用 MAP 选择结果边缘化意图概率

3. 使用开环正向仿真进行安全评估

   对于未通过评估的车辆，我们列举了其意图的所有可能组合。每个组合成为 CFB 选择的情景，并计算情景的概率

4. 根据用户偏好挑选出前k个场景，进一步边缘化前k个场景之间的概率。在评估过程中，边际概率成为 CFB 选择场景的权重

### 4.5 Policy Evaluation 策略评估

策略序列的总体奖励是通过每个 CFB 选择的场景的奖励的加权总和来计算，奖励函数由多个用户定义指标的线性组合组成，包括：

- efficiency:效率（由当前速度和期望速度之间的差异衡量）
- safety:安全（由我们的车辆和周围车辆之间的距离衡量）
- navigation:一致性（由最后的最佳策略和要评估的策略之间的差异衡量）



## 决策算法发展

1. **sequential planning** 基于规则的方式，模块界限分明,不包含学习类算法,决策主要依赖状态机或者部分融入优化cost function里.
2. **behavior-aware planning** 行为感知与规划融合,通过MDP,Game theory,POMDP, Reinforment learning等更靠近机器学习的算法.
3. **end-to-end planning**:一步到位,省略中间步骤,从传感器直接学习到自车行为

### Apollo中的应用

<img src="/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/image-20220505092140395.png" alt="image-20220505092140395" style="zoom:67%;" />

**Apollo6.0中首次引入了基于语义地图的模仿学习**，通过大量的真实路测数据，模仿人类司机在一些特定场景下动态避障的能力，与已有基于优化的规划相结合，增强行车的安全性和舒适性。



# (2019)Safe Trajectory Generation for Complex Urban Environments Using Spatio-Temporal Semantic Corridor (基于时空语义廊道的复杂城市环境安全轨迹生成)

## 特色

1. 在复杂城市环境中，针对不同的语义元素提供一种新的**统一时空语义走廊(ssc)结构**，为不同类型的语义元素提供一个抽象的层次。
2. SSC由一系列相互连接的无碰撞立方体组成，这些立方体由时空域的语义元素构成动态约束。

3. 将轨迹生成可以归结为一般的二次规划问题，在统一ssc框架约束的前提下，可以泛化任意场景的任意组合，最终转化为二次规划问题求解就OK了。

4. 另外轨迹采用分段贝塞尔曲线，利用的是其凸包性质


## related works

### SSC(时空语义走廊)

#### 1 **构建SSC的要素**

1. 语义元素组成的语义地图
2. 动态障碍物的预测轨迹(可选)
3. 正向模拟状态
   - 如果正向模拟状态已经包括其他障碍物车辆(如MPDM)的状态，预测模块可作为可选，这种情况下，我们可以将其他车辆的模拟状态作为预测轨迹，便于从行为规划层到运动规划层进行交互预期。当本文中为实现这一功能，仍采用轨迹预测进行泛化
4. 由Route Planner给出的参考车道

![image-20220505091651808](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/image-20220505091651808.png)

#### 2 要素分类

<img src="/home/next/.config/Typora/typora-user-images/image-20220505090656437.png" alt="image-20220505090656437" style="zoom:80%;" />

- 由语义元素和Frenet框架构成一个slt的三维空间,将类障碍语义元素渲染到slt域后，形成一个三维占栅格。
- 语义元素分为两类:类障碍语义元素和类约束语义元素。

  - **类障碍语义元素**:许多语义元素具有不允许进入slt域的某一部分的物理意义。
    - 静态障碍物：跨越整个时间轴的障碍物
    - 动态障碍物：可以看做是在时域内的一系列静止的障碍物
    - 红灯可看做是特定纵向位置的障碍物体
  - **类约束语义元素**:除类障碍语义元素外，许多语义元素代表动态约束或时间约束。例如，速度限制和停车标志可以被视为速度限制
- 还有一些语义元素会造成时间限制。例如，在过车道时，总变道时间不应过长。

##### 2.1 语义边界

即对类似约束的语义元素提出一个统一的表示，本质是表示某个语义元素开始和停止生效的位置

1. 速度限制可以看作是应用于纵向范围的速度约束
2. 变道时间约束作为当前车道横向范围的时间约束
4. 交通规则在约束中属于硬约束，不可跨越，像换到时间属于认为因素，不可定量去描述

#### 3 SSC生成

![image-20220505005858838](/home/next/.config/Typora/typora-user-images/image-20220505005858838.png)

步骤:第3行：生成粗略立方体；第4行：立方体膨胀；第5步：立方体膨胀限制；第6步：立方体松弛。

![image-20220505005926748](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/image-20220505005926748.png)

- (a) 绿色立方体为决策层给出的初始值，后面的轨迹生成以此为基础来做优化

  - 初始方块由两个初始点作为方块的顶点构成，二者间隙0.15s，假设30m/s，速度行驶，则二者相距4.5m

- (b) 对初始绿色立方体进行膨胀，**膨胀到接触到障碍物(静态/动态的外扩)以及 constraint (例如速度限制)**

- (c) 重复进行膨胀。但要注意拓展的方向部分需要省略，例如第三个立方体需要去掉向下和向左的膨胀，另外图中还有蓝色的线，是对**速度约束的一个松弛变量**

- (d) 在立方体膨胀之后，根据相关约束和自由空间产生立方体弛豫过程，在组合的立方体中利用分段贝塞尔曲线曲线拟合得到优化轨迹

  ![image-20220505001525406](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/image-20220505001525406.png)



### 轨迹生成的安全性和可行性保证

#### 1 贝塞尔曲线简介

![4th-power-bezier-curve](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/4th-power-bezier-curve.gif)

一般形式

![201901131547381694104778 (1)](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/201901131547381694104778 (1).png)

即多项式

![201901131547381775107570](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/201901131547381775107570.png)

称为**伯恩斯坦基函数**

#### 2 贝塞尔曲线 vs 多项式曲线

- **伯恩斯坦基函数与幂基函数的关系**

![201901131547381694104778](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/201901131547381694104778.png)

![201901131547382561367656](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/201901131547382561367656.png)

![22.png](http://www.lu16.com/zb_users/upload/2019/01/201901131547382774121680.png)

最终可以得到

![201901131547382993199032](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/201901131547382993199032.png)

![201901231548248471340721](/home/next/routing_planning/Notes/Typora Notes/paper/港科大/jpg/201901231548248471340721.png)

简单来说就是**贝塞尔曲线能通过一个M矩阵转换为多项式曲线**，即 $C(u) = M \cdot P(t)$ 

**二者最大的不同**

多项式曲线的系数并没有任何的物理意义，而贝塞尔曲线的系数，即公式中的$p_{i}$ 代表的是实际控制点。

#### 3 多项式曲线运用在轨迹规划中的不足

单条多项式曲线无法检测样本点之间的碰撞，因此无法提供对安全性和可行性的任何保证

<img src="/home/next/.config/Typora/typora-user-images/image-20220505000952587.png" alt="image-20220505000952587" style="zoom:80%;" />

#### 4 贝塞尔曲线的特点

1. 一定经过起点和终点

2. 一定不经过控制点 ==> 凸包性质

   <img src="http://www.chuxin911.com/paper_review_Spatio_temporal_Semantic_Corridor_20220226/convex_hull_property.PNG" alt="img" style="zoom: 50%;" />

3. m阶贝塞尔曲线$B(t$)的(m-1)导数后的曲线$B'(t)$仍是一条贝塞尔曲线, $B'(t)$ 的控制点系数满足 $n \cdot (C_{i+1}-C_{i})$ 

4. 固定时间间隔[0,1]间取值,需要对变量做归一化处理

#### 5 Piecewise Bezier Curve Representation

$$
f_{j}^{\sigma}(t)=\left\{\begin{array}{cc}
\alpha_{1} \cdot \sum_{i=0}^{m} p_{i}^{1} \cdot b_{m}^{i}\left(\frac{t-t_{0}}{\alpha_{1}}\right), & t \in\left[t_{0}, t_{1}\right] \\\\
\alpha_{2} \cdot \sum_{i=0}^{m} p_{i}^{2} \cdot b_{m}^{i}\left(\frac{t-t_{1}}{\alpha_{2}}\right), & t \in\left[t_{1}, t_{2}\right] \\\\
\vdots & \vdots \\\\
\alpha_{n} \cdot \sum_{i=0}^{m} p_{i}^{n} \cdot b_{m}^{i}\left(\frac{t-t_{n-1}}{\alpha_{n}}\right), & t \in\left[t_{n-1}, t_{n}\right]
\end{array}\right.
$$

其中$σ ∈ {s, l}$ 两个维度的曲线

#### 代价函数

$$
J_{j}=w_{s} \int_{t_{j-1}}^{t_{j}}\left(\frac{d^{3} f^{s}(t)}{d t^{3}}\right)^{2} d t+w_{l} \int_{t_{j-1}}^{t_{j}}\left(\frac{d^{3} f^{l}(t)}{d t^{3}}\right)^{2} d t
$$

$J_{j}$为第i段的cost function，分别对横纵向求最小 Jerk

#### 约束

1. 起点和终点约束

   起点状态$[σ^{(0)}_{t_0} , σ^{(1)}_{t_0} , σ^{(2)}_{t_0} ]$；终点状态$[σ^{(0)}_{t_n} , σ^{(1)}_{t_n} , σ^{(2)}_{t_n} ]$
   $$
   \frac{d^{k} f_{0}^{\sigma}\left(t_{0}\right)}{d t^{k}}=\sigma_{t_{0}}^{(k)}, \quad \frac{d^{k} f_{n}^{\sigma}\left(t_{n}\right)}{d t^{k}}=\sigma_{t_{n}}^{(k)}
   $$

2. 连续性约束
   $$
   \frac{d^{k} f_{j}^{\sigma}\left(t_{j}\right)}{d t^{k}}=\frac{d^{k} f_{j+1}^{\sigma}\left(t_{j}\right)}{d t^{k}}
   $$

3. 边界约束
   $$
   \beta_{j,-}^{\sigma,(k)} \leq \alpha_{j}^{1-k} \cdot q_{j, i}^{\sigma,(k)} \leq \beta_{j,+}^{\sigma,(k)}, \forall i \Rightarrow \beta_{j,-}^{\sigma,(k)} \leq \frac{d^{k} f_{j}^{\sigma}(t)}{d t^{k}} \leq \beta_{j,+}^{\sigma,(k)} \\ \frac{d^{k} f_{j}^{\sigma}\left(t_{j-1}\right)}{d t^{k}}=\alpha_{j}^{1-k} \cdot q_{j, 0}^{\sigma,(k)}, \frac{d^{k} f_{j}^{\sigma}\left(t_{j}\right)}{d t^{k}}=\alpha_{j}^{1-k} \cdot q_{j, m}^{\sigma,(k)} \\ q_{j, i}^{\sigma,(0)}=p_{i}^{j}, q_{j, i}^{\sigma,(k)}=\frac{m !}{(m-k) !}\left(q_{j, i+1}^{\sigma,(k-1)}-q_{j, i}^{\sigma,(k-1)}\right)
   $$
   第一行是约束的最终表达式

   第二三行为第一行中的参数解释，若k=0，表示立方体膨胀后的边界，如果需要限制曲率或者更高阶导数的化可以对 k=2,3…的情况下进行约束

4. 限制最大加速度为 2m/s^2、最大减速度 3m/s^2
