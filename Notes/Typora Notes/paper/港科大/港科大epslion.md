# EPSILON: An Efficient Planning System for Automated Vehicles in Highly Interactive Environments

## 论文主体

具有交互行为规划层和基于优化的运动规划层

- 行为交互层由部分可观察的马尔科夫决策过程形成(初步决策)
  - 效率的提升表现在将原始问题分解为数量有限的闭环策略评估
  - 引入带有安全机制的驾驶员模型，克服潜在的先验知识不完善带来的风险
- 运动规划
  - 采用**时空语义走廊**(`ssc`)来建立统一的建立复杂的环境约束模型
    - 根据行为规划提供的决策，优化轨迹
    - 遵循基于优化的方案。利用时空语义走廊对复杂语义的所有约束进行统一编码。采用分段贝塞尔曲线作为轨迹参数化方法，对其凸包和速迹特性进行了分析，提高整个轨迹的安全性和动力学可行性。

## 痛点问题的应对方案

- 不确定性建模与多智能体交互
  - 决策出由一系列覆盖规划视界的状态序列
  - 在决策的前提下，优化出一条安全、平滑的规划
  - 最后闭环执行

## 行为规划

- 纯几何推理，假设假设交通参与者的确定性轨迹预测，来检测碰撞，但预测问题多为不确定性和多模态，所以预测应该从概率的角度进行建模
- 本文是从多智能体交互的角度，来决定行为规划，采用`POMDP`方法，来处理不确定性下的问题。`MPDM`过度简化了自我载体的动作:每个候选策略只包含一个语义级动作，持续时间相当长，使`MPDM`成为单阶段`MDP`，这限制了决策的可操作性和智能水平。在本文中，我们保留了`POMDP`的多层结构，并利用领域知识和引导分支来实现更高的效率，同时保持灵活性。

## 运动规划

我们之前的方法[1]属于基于优化的方法。其关键特征是提出了统一的输入表示，即时空语义走廊结构，将各种语义元素构成的复杂约束包裹起来。这种输入表示在工程和调整约束方面节省了大量的工作。然而，与大多数运动规划方法一样，我们之前的方法仍然需要一个轨迹预测模块，没有捕获多智能体交互，这与交互感知行为规划方法相一致。在本文中，由于**预测模块耦合在行为规划中**，我们可以直接将决策与其他交通参与者的条件预期一起提供给运动规划层，这使得[1]中的运动规划器易于建模交互。

## EPSILON系统概述





`RSS`**(Responsibility Sensitive Safety)**的责任敏感安全模型

规则1：**不要撞到前面的车（纵向距离）**

1. 同向行驶

   ![img](https://5b0988e595225.cdn.sohucs.com/images/20180613/ba966a26ea2d443599b569650d48efab.jpeg)

   ![image-20220426190142161](/home/next/.config/Typora/typora-user-images/image-20220426190142161.png)

   - 人类驾驶汽车和自动驾驶汽车的参数可以不同。比如自动驾驶汽车的反应时间一般会比人类短，而且自动驾驶汽车可以比人类驾车的刹车更有效。因此，自动驾驶汽车的αmin,brake可以设置得更大些。
   - 不同路况下可以设置不同的参数（湿滑路面、冰、雪等）

   

2. 反向行驶

   ![img](https://img-blog.csdn.net/20180825222558266?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eHVhbjIwMDYyMDA3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

![image-20220426190043955](/home/next/.config/Typora/typora-user-images/image-20220426190043955.png)

**规则2.与侧方车保持一定安全距离（横向距离）**

因突然并线而导致的追尾，责任在实施并线的车辆。这在现阶段的交通法规中，也是这么定责的，但这并不意味着自动驾驶汽车就可以不作为，`RSS`模型认为，即使旁边车道的车辆突然插入了自动驾驶车辆的前方，只要有足够的距离进行刹车，自动驾驶汽车也必须进行刹车避免碰撞。

![img](https://pic2.zhimg.com/80/v2-61a561dfcc80b8d3bc114c78f8902815_720w.jpg)

![image-20220426190420679](/home/next/.config/Typora/typora-user-images/image-20220426190420679.png)

注：u为允许距离有一个大小波动的范围；这里的v和a都是侧向的速度和加速度

**规则3：路权的享有原则：不争抢路权**

![img](https://5b0988e595225.cdn.sohucs.com/images/20180613/605270ec5c9a4f319b91d48039f54d10.jpeg)

![img](https://5b0988e595225.cdn.sohucs.com/images/20180613/817e172f2db4444cac315d651e1222ec.jpeg)

`RSS`并不是刻板地以路权做为唯一判断，比如在上图图中，蓝车来不及刹车闯入了红车的车道，红车也要采取刹车以避免碰撞。(按规定蓝车应该停车，让红车先过)

![img](https://5b0988e595225.cdn.sohucs.com/images/20180613/5e5f3009383848fa871679d023b72252.jpeg)

甚至，`RSS`模型还可以支持轻微横向位移来避免撞击

**规则4：注意自动驾驶汽车周边的盲区**

下图中的车辆正在通过一排停车位，一名儿童突然以速度10km/h的速度跑过来（比如在追球）。根据计算，10km/h的速度必须要保持15m的安全距离才可能避免碰撞发生。但此时汽车侧方的视野只有0.3m，显然无法满足安全要求。在这种情况下，RSS模型做了如下定义：

-在车辆可以发现目标的第一时间（Te）到反应时间结束时（Te + ρ），车辆没有加速，且到发生撞击或者完全停下来的时刻（Ts），车辆一直以不低于αmin_brake的加速度在刹车。

-从Te到Ts这段时间内，车辆的平均速度低于行人的平均速度。

这种情况下车辆是没有责任的。这个定义隐含的论点是：在发生撞击的时刻，车辆的速度比行人的速度低，或者两者都移动得很慢，从而使撞击的伤害降到最低。

![img](https://5b0988e595225.cdn.sohucs.com/images/20180613/301268f945264876a8c2728a909c6e4e.jpeg)

在这些不确定性高，视眼有限的场景，基本上都是要考虑 worst case

![img](https://img-blog.csdn.net/2018072521452760?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eHVhbjIwMDYyMDA3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)



对于可靠性，使用了`NHTSA`的场景进行测试，cover了99.4%的碰撞情况。

![img](https://img-blog.csdn.net/20180725214606234?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eHVhbjIwMDYyMDA3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

RSS描述的不是驾驶策略，而是对驾驶策略的结果进行安全判定，通过这种规则的设定，希来提前预防、及时避免事故的发生，以及在事故无法避免时，如何将伤亡降到最低。同时，保护OEM厂商的正当权益，避免受到来自社会或监管方不合理的责任分配。

另一方面，RSS在定义不同场景下的危险情况、正确反应、事故责任划分中，是基于人类驾驶员的常识，而非仅仅法律法规。





# 时空安全走廊

## 之前的方法

- 自动驾驶汽车 (AV) 的 RAJECTORY 生成
  在复杂的城市环境中是具有挑战性的，因为有
  有许多语义元素（例如，动态代理、交通信号灯、
  限速、停车标志和车道几何形状）。不同类型的
  语义元素可能有不同的数学描述
  例如障碍、约束和成本[1]。 调音很重要
  不同语义元素组合的效果
  以便该公式可以很好地推广到所有组合
  语义元素[2]。 因此，有必要描述
  不同种类的语义元素以统一的方式，使得
  语义元素的类型和组合不影响
  规划绩效。

- 大多数现有的基于优化的[3]，
  [4] 和基于格的 [5]-[7] 运动规划器尝试检查或
  在一系列采样点上强制执行约束。 然而，这些
  方法可能无法检测或解决之间的不可行点
  两个样本点

## SSC的不同之处

- SSC 的动机是⼤多数语义元素可以呈现为时空障碍或时空域的特 定范围内的约束。 SSC 的关键特性是它对**不同类型的语义元素的抽象**。本质上，SSC 由⼀系列相互连接的⽆碰撞⽴⽅体组成，具有由语义元素构 成的动态约束。我们提出了⼀个 SSC ⽣成过程来⽣成和拆分⽴⽅体，以便 可以正确关联动态约束。给定统⼀的 SSC 表⽰，轨迹⽣成问题归结为在满⾜动态约束的同时 在 SSC 内⽣成最优轨
- 方法
  - 提供了⼀个⼆次规划（QP）公 式，该公式通过使⽤分段⻉塞尔曲线参数化来保证⽣成轨迹的安全性和 可行性。所提出的公式建⽴在凸包和⻉塞尔曲线的全息图属性
  - 要构建 SSC，需要四个要素，即由语义元素组成的语义图、动态代理的预 测轨迹、前向模拟状态和由路线信息给出的参考线
  - 我们不是在笛卡尔坐标中⽣成⾛廊，⽽是采⽤ Frenét 框架表⽰，因为 ⼤多数语义元素都与⻋道⼏何相关联。例如，限速、交通灯和停⻋标志通 常与⻋道的某个纵向范围相关联。此外，由于类⼈驾驶行为通常可以解耦 为横向运动和纵向运动，因此在这两个⽅向上建模⾃由空间⽐在笛卡尔 坐标中建模⾃由空间更⾃然。
- 约束
  -  Obstacle-Like Semantic Elements(障碍语义元素)：许多语义元素具有物理意 义，不允许驱动slt域的某个部分。例如，静态障碍物可以被视为跨越整个 时间轴的障碍物，动态障碍物根据预测的轨迹，可以将其视为时域中的⼀ 系列静态障碍物，⽽红灯可以渲染为占据特定纵向位置和时间段的障碍 物。在将语义元素等障碍物渲染到 slt 域之后，配置空间是⼀个 3-D 占⽤ ⽹格。
  - 类约束语义元素：除了类障碍语义元素外，许多语义元素表⽰动态 约束或时间约束。例如，速度限制和停⻋标志可以被视为速度限制。还有⼀些语义元素会造成时间限制。例如，在交叉⻋道时，换道的总时间不应过⻓
  - 我们为所有类似约束的语义元素提出了⼀个统⼀的表⽰，即语义边 界。例如，可以将速度限制视为应⽤于纵向范围[sbegin, send] 的速度约 束，其中sbegin和send是两个语义边界。变道持续时间约束可以看作是 应⽤于当前⻋道的横向范围[dbegin, dend]的时间约束。本质上，语义边 界代表了某个语义元素开始和停⽌⽣效的位置。
- 语义元素分类
  - 障碍物语义元素，不运行驶入
  - 语义元素边界
    - 纵向：速度限制( a speed limit)
    - 横向：换道时间约束

- 语义走廊生成步骤

SSC 是由于大多数语义元素可以是呈现为时空域一定范围内的时空障碍或约束。的主要特点
SSC 是它对不同类型语义元素的抽象。本质上，SSC 由一系列相互连接的具有动态约束的无碰撞立方体语义元素。我们提出了一个 SSC 生成过程生成并拆分立方体，以便动态约束
可以正确关联。给定统一的 SSC 表示，轨迹生成问题归结为生成最优轨迹在 SSC 内，同时满足动态约束。在这个信中，我们提供了二次规划 (QP) 公式使用 piec 保证生成轨迹的安全性和可行性







# (2021)EPSILON: An Efficient Planning System for Automated Vehicles in Highly Interactive Environments (EPSILON：面向环境交互的高效规划系统)

# (2020)Efficient Uncertainty-aware Decision-making for Automated Driving Using Guided Branching (基于导向分支的高效不确定性自动驾驶决策)

# abstract

## 问题

POMDP提供了一种系统的方法来合并其他交通参与者的潜在随机行为和感知不确定性，但问题在于，把情况扩展到真实世界，会变得非常难以计算。

## 提出解决办法

提出了一种高效的不确定性感知决策框架(EUDM)，该框架可实时生成复杂驾驶环境下的长期横向和纵向行为。通过领域特定的闭环策略树(DCP-Tree)结构和条件聚焦分支(CFB)机制，将计算复杂度控制在合适的水平。

### 核心思想

利用特定领域的专家知识来引导行为空间和意图空间的分支，就是对问题进行剪枝处理

# introduction

## 目标

控制决策问题的计算复杂性，以实现实时执行，同时保持足够的灵活性和保真度，以保持安全性。

文中，提出了一个有效的不确定感知决策(EUDM)框架。首先，EUDM使用特定于领域的闭环策略树(DCP-Tree)来构造语义层的操作空间。策略树中的每个节点都是自车的有限范围语义行为。从根节点到叶节点的每个轨迹代表了自我载体的语义动作序列。每个轨迹以闭环模拟的形式进行评估，但自我行为允许在规划范围内更改

## related works

目前关于自动驾驶的研究大多以解耦的方式解决规划问题，即分成“预测和规划”两个模块。预测结果在一个周期内是固定不变的，这种设计存在着很多缺点：

1. 自车和他车的交互会存在问题，这一个周期(j8s)内自车和他车都在运动，而预测和规划分离却认为结果在一个周期内是固定不变的
2. 考虑到车载传感器不完善的跟踪可能会导致预测错误，从而影响决策的安全性。
3. 假设完美的感知，预测仍然会存在很多不确定性(例如鬼探头，行人过马路)

对上述问题引入POMDP模型框架来解决上述不确定信问题

在EUDM中，DCP树用于指导操作域中的分支，并基于之前的最佳策略更新语义级策略树。然后，ego载体的每个动作序列被安排到一个单独的线程中。对于每个自我行为序列，CFB机制被用于识别附近车辆的危险隐藏意图，并在意图空间中实现引导分支。3292个授权许可使用的输出仅限于：康奈尔大学图书馆。于2020年9月27日11:30:51 UTC从IEEE Xplore下载。限制适用。循环流化床流程是一组场景，包含附近车辆的不同隐藏意图组合。然后通过闭环模拟对每个场景进行评估，以考虑并行子线程中代理之间的交互。所有场景都被输入到成本评估模块，并对风险分支机构应用有偏惩罚。EUDM框架的输出是最佳策略，由闭环正向仿真生成的一系列离散车辆状态（实验中分辨率为0.4s）表示。状态序列被输入运动规划器，以指导轨迹生成过程[28]。

![image-20220505215835756](/home/next/Downloads/港科大epsilon/jpg/image-20220505215835756.png)

我们将横向作用定义为{LK，LCL，LCR}。对于纵向作用，我们使用{加速，保持速度，减速}。

正向模拟闭环模拟的目标是在考虑潜在交互的同时向前推进多智能体系统的状态。仿真模型应在仿真逼真度和推理效率之间实现良好的平衡。我们分别采用智能驾驶模型[29]和纯追踪控制器[30]作为纵向和横向仿真模型。

使用车载传感数据进行开环测试。向上：ego车辆正在接近另一辆车辆并做出LC决策（1和2）。在ego车辆完成LCR后，EUDM检测到由于前车意图不确定而导致的多个风险场景。底部：另一辆车超过了ego车，并猛烈地并入我们的车道（1和2）。EUDM捕捉风险情况并采取适当的减速策略（3）。 

![Snipaste_2022-05-05_22-16-15](Z:\港科大epsilon\jpg\Snipaste_2022-05-05_22-16-15.jpg)

信念更新本研究考虑的隐藏意图包括横向行为，如{LK，LCL，LCR}。如图2所示，在正向模拟期间，对代理车辆的这些意图的信念会更新。在这项工作中，我们采用了一个基于规则的轻量级信念跟踪模块，该模块将一组特征和指标作为输入，包括速度差、距离w.r.t.当前和相邻车道上的领先和跟随代理、责任敏感安全（RSS）[31]和换道模型[32]。信念跟踪器根据意图（即LK、LCL、LCR）生成概率分布。概率作为政策评估的重要权重。在实验中，我们发现基于规则的信念跟踪器虽然结构简单，但工作良好。目前，我们正在探索使用基于学习的信念跟踪器进行意图跟踪[25]，这将被纳入EUDM框架。



循环流化床机理循环流化床的第一步是关键的车辆选择。对于当前车道和相邻车道，我们沿着车道向前和向后搜索一定距离w.r.t.ego车辆的当前速度和该范围内的车辆被标记为关键车辆。第二步是根据初始信念进行不确定车辆选择。具体地说，我们将三种意图的概率相近的车辆选为不确定车辆。注意，对于有信心预测的车辆，我们选择地图意图，并使用地图选择结果边缘化意图概率。第三步是使用开环正演模拟进行安全评估。对于未通过评估的车辆，我们列举了其意图的所有可能组合。每个组合都成为一个CFB选择的场景，并计算场景的概率。第四步是根据用户偏好选择前k个场景，并进一步边缘化前k个场景中的概率。在评估过程中，边际概率成为CFB选择情景的权重



政策评估——政策序列的总体奖励是通过每个CFB选择情景的奖励加权总和计算的。奖励函数由多个用户定义指标的线性组合组成，包括效率（通过当前速度和期望速度之间的差异衡量）、安全性（通过我们的车辆和周围车辆之间的距离衡量）和一致性（通过最后一个最佳策略和待评估策略之间的差异衡量）。

轨迹生成我们的行为规划器的输出是一系列分辨率为0.4秒的自我载体的离散状态。行为计划被输入到我们之前工作[28]中提出的运动规划器中，该规划器利用时空走廊结构生成安全且动态可行的轨迹。



pomdp

那么问题就在，如何预测或者评估其他车辆的意图、行为，并给出不确定性指标。在现有的理论框架下，部分观测马尔科夫决策过程（Partial Observable Markov Decision Process, POMDP）能提供理论上最优的解决方案，即在考虑多车相互影响的不确定性前提下，提供最优的决策和规划。但POMDP并不是Freelunch，虽然理论完备，但是离实际在无人车决策的应用存在一定距离。最大的障碍就是实时性，POMDP的求解是需要多次迭代，以期得到最优的状态-动作的对应函数（policy）。连续POMDP的通用解法本身就是一个难度很大且目前尚待解决的课题，这里不做更深的讨论。这里只介绍目前无人车学界对于POMDP现有算法的应用和改进。为了弥补在线求解的实时性问题，有学者提出了各种优化。最直观、也是最简便的一种离散化就是对行为的离散，即决策时，仅考虑抽象行为，如“保持直行”、“左变线”、“右变线”等动作，然后通过离散POMDP求解。这种办法较为直接、实用。另外一种离散的方式是对Policy的离散，即预制好多种最优解以应对不同的状况，POMDP仅需要挑选对应目前状况最优的一个policy即可，大大降低了计算难度和求解时间。不过预制多种最优policy也是一项很大的工程。虽然可以线下计算（off-line）但难以涵盖所有的状况。如果遇到了跟预制完全不同的状况，还是需要重新计算新的policy。

# (2019)Safe Trajectory Generation for Complex Urban Environments Using Spatio-Temporal Semantic Corridor (基于时空语义廊道的复杂城市环境安全轨迹生成)

## Abstract

在复杂城市环境中，针对不同的语义元素提供一种新的统一时空语义走廊(ssc)结构，为不同类型的语义元素提供一个抽象的层次。

SSC由一系列相互连接的无碰撞立方体组成，这些立方体由时空域的语义元素构成动态约束。

而轨迹生成可以归结为一般的二次规划问题，在统一ssc框架约束的前提下，可以泛化任意场景的任意组合，最终转化为二次规划问题求解就OK了。

另外轨迹采用分段贝塞尔曲线，利用的是其凸包性质

## Introduction

SSC的关键特性是它对不同类型的语义元素的抽象。本质上，SSC由一系列相互连接的无碰撞立方体组成，这些立方体具有由语义元素构成的动态约束。我们提出了一个SSC生成过程来生成和分割立方体，以便动态约束可以正确关联。给定统一的SSC表示，轨迹生成问题归结为在满足动力学约束的情况下生成SSC内的最优轨迹。在本文中，我们提出了一个二次规划(QP)公式，该公式使用分段Bézier曲线参数化，保证了所生成轨迹的安全性和可行性。

## related works

一个计划周期有四个阶段

- 第一阶段是语义地图管理人员获得的环境理解，该管理人员负责管理用于本地规划目的的语义元素(例如占用网格地图、动态代理、车道、交通规则等)。
- 第二阶段是预测，它不仅提供高层次的行为预期(如车道改变、车道保持等)，而且还预测了其他动态agent的轨迹。
- 第三阶段是行为规划，该阶段使用多策略决策(MPDM)方法实现，如第四节所述。
- 第四阶段是我们提出的运动规划，它将来自行为规划器的离散未来模拟状态作为走廊生成的基础状态。

构建ssc需要4个要素

- 语义元素组成的语义地图
- 动态障碍物的预测轨迹
- 正向模拟状态
  - 如果正向模拟状态已经包括其他障碍物车辆(如MPDM)的状态，预测模块可作为可选，这种情况下，我们可以将其他车辆的模拟状态作为预测轨迹，便于从行为规划层到运动规划层进行交互预期。当本文中为实现这一功能，仍采用轨迹预测进行泛化
- 由路径信息给出的参考车道

### 简述行为规划

采用MPDM模型将行为规划问题描述为一个通用的多智能体部分可观察马尔可夫决策过程(POMDP)，对动态环境中的交互和不确定性进行建模。当车辆较多时，为了快速求解POMDP,MPDM放松了这个问题，并假设我们的车辆和其他代理都在执行一个有限的闭环离散策略集(例如，变道、保持车道等)。此外，对于每个闭环策略，通过使用简化的仿真模型(如理想转向和速度控制器的复杂城市环境的安全轨迹生成)，对未来的情况进行预测，设计一个综合的奖励函数来评估未来的情况，并选出最佳的行为。

状态作为走廊生成过程中的种子。虽然初始种子是无碰撞的，但由于分辨率较低（实验中为0.15秒）和简化的仿真模型（例如，实验中为分段线性控制），车辆无法直接执行这些种子。由于MPDM同时为多个行为（如左换车道、右换车道和保持车道）提供正向模拟状态，因此我们充分利用这一特性，为所有潜在行为生成候选轨迹，以增强框架的鲁棒性。例如，在执行车道变换轨迹时，我们的轨迹框架总是准备好切换回原始车道的轨迹，

### 时空语义走廊

### 框架描述

由语义元素和Frenet框架构成一个slt的三维空间。

参考车道是从路线规划者提供的路线信息中提取。

不同类型的语义元素一般可分为两类:类障碍语义元素和类约束语义元素。

1. 类障碍语义元素:许多语义元素具有不允许进入slt域的某一部分的物理意义。例如,静态障碍可以被视为障碍在整个时间轴,和动态障碍可以看作是一系列的静态障碍在时域预测轨迹,而红灯可以呈现为一个障碍占据特定的纵向位置和时间。将类障碍语义元素渲染到slt域后，配置空间就是一个三维占用网格。
2. 类约束语义元素:除类障碍语义元素外，许多语义元素代表动态约束或时间约束。例如，速度限制和停止标志可以被视为速度限制
3. 还有一些语义元素会造成时间限制。例如，在过车道时，总变道时间不应过长。

文章对类似约束的语义元素提出一个统一的表示，即语义边界

1. 速度限制可以看作是应用于纵向范围的速度约束
2. 变道时间约束可以看作是应用于当前车道横向范围的时间约束
3. 本质上，语义边界表示某个语义元素开始和停止生效的位置
4. 交通规则在约束中属于硬约束，不可跨越，像换到时间属于认为因素，不可定量去描述

![Snipaste_2022-05-05_23-02-09](Z:\港科大epsilon\jpg\Snipaste_2022-05-05_23-02-09.jpg)

环境的复杂语义元素被投射到时空域w.r.t.参考通道。SSC对语义元素给出的需求进行编码，并据此生成安全轨迹。请注意，静态障碍物的可视化会被剪裁，以显示其他组件的详细信息

![Snipaste_2022-05-05_23-07-24](Z:\港科大epsilon\jpg\Snipaste_2022-05-05_23-07-24.jpg)

### 时空语义走廊生成

![image-20220504164125958](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220504164125958.png)

![image-20220505231044875](Z:\港科大epsilon\jpg\image-20220505231044875.png)

算法1中概述,生成过程由种子代(第3行),立方体通货膨胀(第4行),约束协会(第5行)和立方体放松(第6行)。

1. a)绿色立方体为决策层给出的初始值(初始方块由两个连续的点生成，将这两个种子作为方块的顶点)，后面的轨迹生成以此为基础来做优化
2. b)对初始绿色立方体进行膨胀，膨胀到接触到障碍物(静态/动态的外扩)以及 constraint (例如速度限制)
3. c)重复进行膨胀。但要注意拓展的方向部分需要省略，例如第三个立方体需要去掉向下和向左的膨胀，另外图中还有蓝色的线，是对速度约束的一个松弛变量
4. d)在立方体膨胀之后，根据相关约束和自由空间应用立方体弛豫过程，在组合的立方体中利用B样条曲线拟合得到优化轨迹

ps:红的线框为限速区，蓝色线为可通过的边界线







![image-20220504171507267](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220504171507267.png)

1)种子生成:预测所产生的语义走廊的种子的正向模拟状态行为规划师slt配置空间。由于正演模拟状态是离散化的，通道生成过程的可行性取决于环境的复杂性和种子的分辨率。为了保证走廊生成过程的成功，我们要求由连续种子构造的初始立方体无碰撞(图4(a)和算法2第6行)。在实践中，这种间隙要求是合理的，易于实现。例如，对于一辆以30米/秒的纵向速度和0.15秒的种子分辨率行驶的车辆，所需的间隙约为4.5米，比如此高速下的紧急制动距离短得多。因此，直接拒绝违反建议要求的案例是合理的。在种子周围生成通道的动机是在保持相同的高级行为的同时，完全模拟拓扑等效自由空间。例如，如图4(a)所示，种子的语义为在两个动态障碍物之间传递，通道将其保留的一代。由于运动规划器应该与任何给定的初始状态一起工作，初始状态也应该包含在种子中。

2)带语义边界的立方体膨胀:走廊是通过迭代种子生成的。已经包含在最后一个充气立方体中的种子将被跳过(第4行，算法2)，因为它们在拓扑上是等价的。初始立方体是基于两个连续的种子生成的，将这两个种子作为两个立方体的顶点(第5行，算法2)。

立方体膨胀的关键特征是考虑语义边界(第9行，算法2).数据集膨胀过程的目标是生成匹配语义边界的数据集，以便方便地关联约束。具体来说，当初始立方体与某个语义边界相交时，禁止与进入方向相反的膨胀方向，这样膨胀后的立方体几乎可以与语义边界相匹配。对于膨胀的一个步骤，膨胀在三个狭缝方向之间交替，如果这个步骤与障碍物碰撞或与某个特定的物体相交，膨胀就终止。

代码中提供的例子是图4 (b)和(c)。因为在优化(第六部分)每个多维数据集对应一条轨迹保持凸性,我们没有明确优化时间的碎片,当前数据集的时间上限应该配合时间下界的下一个多维数据集。人们可以考虑优化持续时间(这是非凸的)，在这种情况下，进一步膨胀以增加t维度的重叠可能是有益的。

3)立方体松弛:经过立方体膨胀过程后，膨胀后的立方体几乎匹配语义边界，如图4(c)所示。但正如V -A2中所提到的，有些约束条件比较软，如变道时间约束，需要留出额外的空间进行优化。为此，我们采用立方体弛豫过程来放松立方体边界，同时保持硬约束和无碰撞特性，如图4(d)所示。松弛所允许的最大余量由应用于两个连续立方体的约束系统地确定



### 轨迹生成具有安全性和可行性保证







1. **sequential planning**:传统的方式,模块界限分明,几乎没有基于学习类的算法,决策主要依赖状态机或者部分融入优化cost function里.
2. **behavior-aware planning**:决策与规划融合,通过MDP,Game theory,POMDP, Reinforment learning等更靠近机器学习的算法.
3. **end-to-end planning**:一步到位,省略中间步骤,从传感器直接学习到自车行为

**与机器学习结合：**随着以 神经网络为代表的人工智能的快速发展，许多传统的 规划问题也带来了新的解决思路。在自动驾驶领域，其发展趋势包括：

- 端到端模型：使用一个深度 神经网络，直接根据车辆状态和外部环境信息得出车辆的控制信号。尽管目前的端到端模型存在类似“黑箱”的不可解释性，但相信随着人类对深度 神经网络理解的不断加深，这一方法因其突出的简洁高效优势而具有很强的发展潜力。
- 决策与 运动 规划 模块融合

自动驾驶车辆在复杂环境中作出最优决策，这一问题与强化学习的定义非常吻合，因此如前文所述，随着 深度强化学习技术的快速发展，越来越多的研究团队开始将其应用于自动驾驶决策 规划中，将行为决策与 运动 规划 模块相融合，直接学习得到行驶轨迹。为了解决环境奖励函数不易获得的问题，人们还提出了首先利用逆强化学习（IRL）根据人类专家演示学习，然后使用强化学习来学习最优策略。



![image-20220505092140395](Z:\港科大epsilon\jpg\image-20220505092140395.png)



**在规划上，Apollo 6.0 首次引入了基于语义地图的模仿学习**,通过大量的真实路测数据，模仿人类司机在一些特定场景下动态避障的能力，与已有基于优化的规划相结合，显著增强了行车的安全性和舒适性





## 规划与决策

存在问题：

1. 当前环境感知系统不太准确，导致预测模块(意图与轨迹)结果不准确，导致自车与目标博弈算法失败，使得决策系统更倾向于保守的规则(停车)。比如评估当前场景变化莫测，系统很难避障，系统就会选择停车，而如果与后车间距又太小，就会一直等着，直到前方可通行。
2. 对驾驶场景的描述。根据划分力度的不同，会造成场景的数量不断的增加。几百万到几千万量级都是有可能的，无法去评估。
3. 超低速情况也是planning的一个主要挑战。因为车辆设计都会有一个待速的要求，如果低于这个速度了可能会熄火，尤其是内燃机这种车。而在待速情况下很难走出预先设定的轨迹，不够细腻，造成避障与会车的失败。人由于在驾驶可以含着刹车，并且开车处于不断试探的过程，可以不断博弈，而自动驾驶就无法很好的cover。
4. 决策的伦理性和责任认定还不成熟。

未来发展：

深度强化学习去做场景的决策，一遍cover大量的规则，但模型的设计与训练过程还是需要进一步发展。



dcp树本质上决定了自我载体的初步语义层动作序列，但其他主体载体的行为(意图)仍然不确定。由于代理车辆的意图组合呈指数级爆炸，天真地对所有可能的代理意图组合进行抽样是低效的。为了克服这一点，EUDM使用条件聚焦分支(CFB)机制，利用开环安全评估条件下的自我行动序列，挑选出潜在的风险场景。EUDM具有高度的并行性，可以实时(20hz)产生长期(最长8秒)的横向和纵向细粒度行为计划。

apollo 7.0公开课

![image-20220505110058884](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220505110058884.png)
